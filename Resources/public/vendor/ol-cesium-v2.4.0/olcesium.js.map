{"version":3,"sources":["webpack://olcs_unused_var/webpack/bootstrap","webpack://olcs_unused_var/external \"ol.proj\"","webpack://olcs_unused_var/external \"ol.Observable\"","webpack://olcs_unused_var/external \"ol.layer.Group\"","webpack://olcs_unused_var/external \"ol.source.Vector\"","webpack://olcs_unused_var/external \"ol.layer.Image\"","webpack://olcs_unused_var/external \"ol.source.Cluster\"","webpack://olcs_unused_var/external \"ol.layer.Vector\"","webpack://olcs_unused_var/external \"ol.geom.Geometry\"","webpack://olcs_unused_var/external \"ol.extent\"","webpack://olcs_unused_var/external \"ol.geom.Point\"","webpack://olcs_unused_var/external \"ol.easing\"","webpack://olcs_unused_var/external \"ol.layer.Tile\"","webpack://olcs_unused_var/external \"ol.source.ImageStatic\"","webpack://olcs_unused_var/external \"ol.source.ImageWMS\"","webpack://olcs_unused_var/external \"ol.source.TileImage\"","webpack://olcs_unused_var/external \"ol.source.TileWMS\"","webpack://olcs_unused_var/external \"ol.source.Image\"","webpack://olcs_unused_var/external \"ol.layer.Layer\"","webpack://olcs_unused_var/external \"ol.style.Icon\"","webpack://olcs_unused_var/external \"ol.geom.Polygon\"","webpack://olcs_unused_var/external \"ol.geom.SimpleGeometry\"","webpack://olcs_unused_var/external \"ol.Overlay\"","webpack://olcs_unused_var/./src/olcs/util.js","webpack://olcs_unused_var/./src/olcs/core/OLImageryProvider.js","webpack://olcs_unused_var/./src/olcs/core.js","webpack://olcs_unused_var/./src/olcs/AutoRenderLoop.js","webpack://olcs_unused_var/./src/olcs/math.js","webpack://olcs_unused_var/./src/olcs/Camera.js","webpack://olcs_unused_var/./src/olcs/AbstractSynchronizer.js","webpack://olcs_unused_var/./src/olcs/RasterSynchronizer.js","webpack://olcs_unused_var/./src/olcs/core/VectorLayerCounterpart.js","webpack://olcs_unused_var/./src/olcs/FeatureConverter.js","webpack://olcs_unused_var/./src/olcs/VectorSynchronizer.js","webpack://olcs_unused_var/./src/olcs/SynchronizedOverlay.js","webpack://olcs_unused_var/./src/olcs/OverlaySynchronizer.js","webpack://olcs_unused_var/./src/olcs/OLCesium.js","webpack://olcs_unused_var/./src/olcs/contrib/LazyLoader.js","webpack://olcs_unused_var/./src/olcs/contrib/Manager.js","webpack://olcs_unused_var/./src/index.library.js"],"names":["installedModules","__webpack_require__","moduleId","exports","module","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","ol","proj","Observable","layer","Group","source","Vector","Image","Cluster","geom","Geometry","extent","Point","easing","Tile","ImageStatic","ImageWMS","TileImage","TileWMS","Layer","style","Icon","Polygon","SimpleGeometry","Overlay","olcsListen","observable","type","listener","on","obj","param","supportsImageRenderingPixelatedResult_","undefined","imageRenderingValueResult_","supportsImageRenderingPixelated","canvas","document","createElement","setAttribute","tmp","imageRenderingValue","getSourceProjection","getProjection","uidCounter_","getUid","olcs_uid","OLImageryProvider","olMap","opt_fallbackProj","_this","this","source_","projection_","fallbackProj_","ready_","tilingScheme_","rectangle_","map_","proxy","proxy_","getURL","Cesium","DefaultProxy","errorEvent_","Event","emptyCanvas_","width","height","e","handleSourceChanged_","frameState","getState","olcsUtil","GeographicTilingScheme","WebMercatorTilingScheme","rectangle","getTileCredits","x","y","level","olExtent","getView","calculateExtent","getSize","viewState","zoom","attributionsFunction","getAttributions","attributions","Array","isArray","map","html","Credit","requestImage","tileUrlFunction","getTileUrlFunction","z_","y_","url","ImageryProvider","loadImage","defineProperties","ready","tileWidth","tg","getTileGrid","getTileSize","tileHeight","maximumLevel","getMaxZoom","minimumLevel","tilingScheme","tileDiscardPolicy","errorEvent","hasAlphaChannel","pickFeatures","scene","target","camera","frustum","distance","Cartesian3","magnitude","subtract","position","pixelSize","Cartesian2","getPixelDimensions","clientWidth","clientHeight","amount","computePixelSizeAtCoordinate","transform","Transforms","eastNorthUpToFixedFrame","bottomLeft","Matrix4","multiplyByPoint","topRight","Ellipsoid","WGS84","cartesianArrayToCartographicArray","geometry","applyTransform","input","output","stride","length","coordinates","rotation","translation","scale","ZERO","ol4326CoordinateToCesiumCartesian","rawMatrix","quaternion","Quaternion","fromAxisAngle","UNIT_Z","rotationMatrix","fromTranslationQuaternionRotationScale","multiply","angle","axis","opt_options","clamp","Math","defaultValue","options","duration","linearEasing","callback","lastProgress","oldTransform","start","Date","now","window","requestAnimationFrame","step","timestamp","progress","clone","stepAngle","lookAtTransform","rotate","heading","bottomCenter","angleToZenith","computeAngleToZenith","right","Matrix3","fromQuaternion","vector","zenith","multiplyByVector","add","fromTranslation","rotateAroundAxis","pixel","ray","getPickRay","globe","pick","pickEllipsoid","bottom","pickOnTerrainOrEllipsoid","center","Ray","direction","ellipsoid","IntersectionTests","rayEllipsoid","getPoint","normal","geocentricSurfaceNormal","angleBetween","signedAngleBetween","PI","convertLongitudeRange","fovy2","fovy","matrix","first","second","a","b","normalize","cross","cosine","dot","sine","sign","atan2","pivot","fy","bottomFovRay","negate","left","projection","ext","transformExtent","Rectangle","fromDegrees","olLayer","viewProj","olLayerTile","olLayerImage","provider","getSource","olSourceImageWMS","getUrl","getImageLoadFunction","defaultImageLoadFunction","sourceProps","olcs.proxy","olcs.extent","olcs.projection","olcs.imagesource","olSourceTileWMS","params","getParams","setProperties","olSourceTileImage","isCesiumProjection","olcsCoreOLImageryProvider","olSourceImageStatic","SingleTileImageryProvider","getImageExtent","layerOptions","getExtent","extentToRectangle","ImageryLayer","olLayerWithParents","csLayer","opacity","visible","concat","parents","forEach","layerOpacity","getOpacity","layerVisible","getVisible","alpha","show","coordinate","coo","toCartesian","cartesians","push","proj4326","properties","getProperties","olColor","Color","byteToFloat","fromCssColorString","CanvasPattern","CanvasGradient","ctx","getContext","fillStyle","fillRect","ImageMaterialProperty","image","subdomains","re","match","exec","replace","charCode","startCharCode","charCodeAt","stopCharCode","String","fromCharCode","Promise","resolve","reject","pickBottomPoint","currentHeading","getRotation","setHeadingUsingBottomCenter","view","normalizeView","resolution","getResolution","setRotation","setResolution","constrainResolution","is3857","is4326","AutoRenderLoop","ol3d","scene_","getCesiumScene","canvas_","_boundNotifyRepaintRequired","notifyRepaintRequired","repaintEventNames_","enable","requestRenderMode","maximumRenderTimeChange","_iterator","_isArray","_i","iterator","_ref","next","done","repaintKey","addEventListener","getOlMap","getLayerGroup","disable","_iterator2","_isArray2","_i2","_ref2","removeEventListener","un","restartRenderLoop","requestRender","toDegrees","angleInRadians","toRadians","angleInDegrees","Camera","cam_","view_","viewListenKey_","toLonLat_","identityProjection","fromLonLat_","tilt_","distance_","lastCameraViewMatrix_","viewUpdateInProgress_","setView_","opt_output","opt_dimension","dim","_this2","olObservableUnByKey","toLonLat","getTransform","fromLonLat","handleViewEvent_","readFromView","setHeading","getHeading","setTilt","tilt","updateCamera_","getTilt","setDistance","updateView","getDistance","setCenter","getCenter","setPosition","ll","carto","Cartographic","getAltitude","setView","destination","cartographicToCartesian","getPosition","cartesianToCartographic","pos","longitude","latitude","setAltitude","altitude","getHeight","orientation","pitch","PI_OVER_TWO","roll","moveBackward","checkCameraChange","calcDistanceForResolution","olcsCore","pickCenterPoint","bestTarget","positionCartographic","bestTargetCartographic","calcResolutionForDistance","targetNormal","targetToCamera","up","z","tiltAngle","acos","isNaN","opt_dontSync","old","current","viewMatrix","equalsEpsilon","metersPerUnit","getMetersPerUnit","cos","abs","tan","AbstractSynchronizer","olLayers","getLayers","mapLayerGroup","layerMap","olLayerListenKeys","olGroupListenKeys_","synchronize","destroyAll","addLayers_","orderLayers","root","fifo","_loop","splice","olLayerId","toString","cesiumObjects","olLayerGroup","listenForGroupChanges_","createSingleLayerCounterparts","newOlLayerWithParents","layerId","layerWithParents","onLayerChange","cesiumObjs","addCesiumObjects_","cesiumObject","addCesiumObject","removeAndDestroySingleLayer_","_this3","uid","counterparts","counterpart","removeSingleCesiumObject","destroyCesiumObject","unlistenSingleGroup_","group","removeLayer_","_this4","uuid","listenKeyArray","contentKeys","listenAddRemove","_this5","collection","event","element","apply","el","indexOf","objKey","removeAllCesiumObjects","destroy","RasterSynchronizer","_olcsAbstractSynchron","cesiumLayers_","imageryLayers","ourLayers_","ImageryLayerCollection","remove","removeAll","convertLayerToCesiumImageries","result","tileLayerToImageryLayer","_this$olLayerListenKe","olLayerItem","updateCesiumLayerProperties","layers","zIndices","queue","getZIndex","sublayers","unshift","getArray","arr","compareFnc","index","sort","stableSort","layer1","layer2","raiseToTop","olcsAbstractSynchronizer","VectorLayerCounterpart","layerProjection","billboards","BillboardCollection","primitives","PrimitiveCollection","olListenKeys","rootCollection_","context","featureToCesiumMap","getRootPrimitive","FeatureConverter","boundOnRemoveOrClearFeatureListener_","onRemoveOrClearFeature_","evt","cancellers","feature","id","canceller","setReferenceForPicking","primitive","olFeature","createColoredPrimitive","olGeometry","color","opt_lineWidth","flat","renderState","depthTest","enabled","lineWidth","instances","instance","GeometryInstance","attributes","ColorGeometryInstanceAttribute","fromColor","createInstance","getHeightReference","HeightReference","CLAMP_TO_GROUND","ctor","constructor","GroundPrimitive","geometryInstances","Primitive","dataUri","getValue","toDataURL","appearance","MaterialAppearance","material","Material","fabric","uniforms","PerInstanceColorAppearance","extractColorFromOlStyle","outline","fillColor","getFill","getColor","strokeColor","getStroke","convertColorToCesium","extractLineWidthFromOlStyle","getWidth","wrapFillAndOutlineGeometries","fillGeometry","outlineGeometry","olStyle","outlineColor","p1","p2","addTextStyle","getText","text","label","olGeometry4326TextPartToCesium","csAddBillboard","bbOptions","bb","olCircleGeometryToCesium","olGeometryCloneTo4326","point","slice","getRadius","outlinePrimitive","radius","CircleGeometry","circlePolygon","olCreateCircularPolygon","positions","ol4326CoordinateArrayToCsCartesians","getLinearRing","getCoordinates","GroundPolylinePrimitive","isSupported","GroundPolylineGeometry","PolylineMaterialAppearance","olStyleToCesium","classificationType","ClassificationType","TERRAIN","readyPromise","then","_primitive","createStackedGroundCorridors","CircleOutlineGeometry","extrudedHeight","max","previousDistance","_arr","geometryOptions","vertexFormat","VertexFormat","POSITION_ONLY","linePositions","CorridorGeometry","distanceDisplayCondition","DistanceDisplayConditionGeometryInstanceAttribute","olLineStringGeometryToCesium","heightReference","primitiveOptions","PolylineGeometry","olPolygonGeometryToCesium","getGeometry","boundingExtent","maxHeight","RectangleGeometry","RectangleOutlineGeometry","rings","getLinearRings","hierarchy","polygonHierarchy","olPos","holes","PolygonGeometry","perPositionHeight","_i4","polylineGeometry","PolygonOutlineGeometry","altitudeMode","NONE","RELATIVE_TO_GROUND","createBillboardFromImage","imageStyle","opt_newBillboardCallback","olStyleIcon","load","getImage","reallyCreateBillboard","HTMLCanvasElement","HTMLImageElement","getScale","verticalOrigin","VerticalOrigin","BOTTOM","src","naturalHeight","naturalWidth","complete","isImageLoaded","cancelled","fuid","isDestroyed","olPointGeometryToCesium","modelPrimitive","olcsModelFunction","olcsModel","assign","cesiumOptions","model","Model","fromGltf","debugModelMatrix","DebugModelMatrixPrimitive","modelMatrix","olMultiGeometryToCesium","subgeos","accumulate","geometries","functor","getType","getPoints","getLineStrings","getPolygons","labels","LabelCollection","extentCenter","olGeomSimpleGeometry","getFirstCoordinate","offsetX","getOffsetX","offsetY","getOffsetY","offset","pixelOffset","font","getFont","horizontalOrigin","labelStyle","LabelStyle","FILL","outlineWidth","OUTLINE","FILL_AND_OUTLINE","getTextAlign","HorizontalOrigin","LEFT","RIGHT","CENTER","getTextBaseline","TOP","fill","stroke","getLineDash","fromType","horizontal","repeat","evenColor","oddColor","computePlainStyle","fallbackStyleFunction","featureStyleFunction","getStyleFunction","getGeometryFromFeature","opt_geom","geom3d","olGeomGeometry","geomFuncRes","getGeometryFunction","olFeatureToCesium","newBillboardAddedCallback","featureBb","getGeometries","prims","bbs","result2","Error","olVectorLayerToCesium","olView","featurePrimitiveMap","olSourceCluster","features","getFeatures","olcsCoreVectorLayerCounterpart","layerStyle","styles","prim","convert","VectorSynchronizer","opt_converter","converter","olcsFeatureConverter","csAllPrimitives_","destroyPrimitives","updateLayerVisibility","csPrimitive","olLayerVector","csPrimitives","onAddFeature","onRemoveFeature","Billboard","SynchronizedOverlay","parent","_olOverlay","getOptions","scenePostRenderListenerRemover_","synchronizer_","synchronizer","parent_","positionWGS84_","observer_","MutationObserver","handleElementChanged","_assertThisInitialized","attributeObserver_","listenerKeys_","setPropertyFromEvent","setPropertyFromEvent_","handleMapChanged","observeTarget_","disconnect","observe","childList","characterData","subtree","observer","childNodes","node","nodeType","set","getScene","parentNode","removeChild","postRender","updatePixelPosition","container","stopEvent","getOverlayContainerStopEvent","getOverlayContainer","insertFirst","insertBefore","appendChild","handlePositionChanged","sourceProjection","getMap","cloneNode","Node","TEXT_NODE","dispatchEvent","MouseEvent","stopPropagation","nodes","lastChild","removeChildren","getElement","clonedNode","cartesian","fromDegreesArray","fromDegreesArrayHeights","ellipsoidBoundingSphere","BoundingSphere","Occluder","isPointVisible","computeCullingVolume","computeVisibility","setVisible","pixelCartesian","cartesianToCanvasCoordinates","mapSize","updateRenderedPosition","removeNode","olOverlay","OverlaySynchronizer","overlays_","getOverlays","overlayContainerStopEvent_","className","parentElement","overlayContainer_","overlayMap_","addOverlays","addOverlayFromEvent_","removeOverlayFromEvent_","overlay","addOverlay","cesiumOverlay","olcsSynchronizedOverlay","overlayId","removedOverlay","removeOverlay","csOverlay","keys","OLCesium","autoRenderLoop_","time_","time","JulianDate","to4326Transform_","resolutionScale_","canvasClientWidth_","canvasClientHeight_","resolutionScaleChanged_","fillArea","container_","containerAttribute","createAttribute","setAttributeNode","targetElement","getElementById","oc","getViewport","querySelector","isOverMap_","stopOpenLayersEventsPropagation","overlayEvents","ii","canvasAttribute","oncontextmenu","onselectstart","enabled_","pausedInteractions_","hiddenRootGroup_","sceneOptions","scene3DOnly","Scene","sscc","screenSpaceCameraController","tiltEventTypes","eventType","CameraEventType","LEFT_DRAG","modifier","KeyboardEventModifier","SHIFT","ALT","enableLook","constrainedAxis","camera_","olcsCamera","globe_","Globe","baseColor","WHITE","skyAtmosphere","SkyAtmosphere","firstImageryProvider","addImageryProvider","dataSourceCollection_","DataSourceCollection","dataSourceDisplay_","DataSourceDisplay","dataSourceCollection","synchronizers","createSynchronizers","olcsRasterSynchronizer","olcsVectorSynchronizer","olcsOverlaySynchronizer","handleResize_","lastFrameTime_","renderId_","targetFrameRate_","Number","POSITIVE_INFINITY","blockCesiumRendering_","warmingUp_","trackedFeature_","trackedEntity_","entityView_","needTrackedEntityUpdate_","boundingSphereScratch_","EventHelper","updateTrackedEntity_","enableSuspendTerrainAdjustment","render_","cancelAnimationFrame","onAnimationFrame_","frameTime","interval","julianDate","initializeFrame","update","trackedEntity","getBoundingSphere","BoundingSphereState","DONE","render","state","PENDING","enableTilt","bs","FAILED","EntityView","mapProjection","resolutionScale","devicePixelRatio","aspectRatio","getCamera","getOlView","getDataSources","getDataSourceDisplay","getEnabled","setEnabled","interactions","visibility","throwOnUnitializedMap_","getInteractions","clear","rootGroup","classList","interaction","warmUp","timeout","csCamera","setTimeout","setBlockCesiumRendering","block","enableAutoRenderLoop","olcsAutoRenderLoop","getAutoRenderLoop","setResolutionScale","setTargetFrameRate","isDef","trackedFeature","defaultDataSource","entities","IDENTITY","to4326Transform","CallbackProperty","coo4326","TRANSPARENT","promise","url_","script","onload","onerror","head","Manager","_olObservable","cesiumUrl","_temp","cameraExtentInRadians","cesiumUrl_","boundingSphere_","blockLimiter_","promise_","cesiumInitialTilt_","fogDensity","fogSSEFactor","minimumZoomDistance","maximumZoomDistance","limitCameraToBoundingSphereRatio","_proto","cesiumLazyLoader","olcsContribLazyLoader","onCesiumLoaded","rect","_construct","DEFAULT_VIEW_RECTANGLE","fromRectangle3D","instantiateOLCesium","configureForUsability","configureForPerformance","terrainProvider","createWorldTerrain","fog","density","screenSpaceErrorFactor","sscController","depthTestAgainstTerrain","backgroundColor","limitCameraToBoundingSphere","fromCartesian","ratio","flying","unblockLimiter","flyToBoundingSphere","cancel","toggle3d","is3DCurrentlyEnabled","resetToNorthZenith","rotateAroundBottomCenter","set3dWithView","lon","lat","elevation","headingDeg","pitchDeg","is3dEnabled","getTiltOnGlobe","computeSignedTiltAngleOnGlobe","getOl3d","getCesiumViewMatrix","flyToRectangle","_this6","getRectangleCameraCoordinates","mag","multiplyByScalar","flyTo","endTransform","getCameraExtentRectangle","olObservable","olcs","__webpack_exports__","olcs_OLCesium","olcs_AbstractSynchronizer","olcs_RasterSynchronizer","olcs_VectorSynchronizer","core","core_OLImageryProvider","core_VectorLayerCounterpart","contrib","LazyLoader","contrib_Manager"],"mappings":"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","file":"olcesium.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 22);\n","module.exports = ol.proj;","module.exports = ol.Observable;","module.exports = ol.layer.Group;","module.exports = ol.source.Vector;","module.exports = ol.layer.Image;","module.exports = ol.source.Cluster;","module.exports = ol.layer.Vector;","module.exports = ol.geom.Geometry;","module.exports = ol.extent;","module.exports = ol.geom.Point;","module.exports = ol.easing;","module.exports = ol.layer.Tile;","module.exports = ol.source.ImageStatic;","module.exports = ol.source.ImageWMS;","module.exports = ol.source.TileImage;","module.exports = ol.source.TileWMS;","module.exports = ol.source.Image;","module.exports = ol.layer.Layer;","module.exports = ol.style.Icon;","module.exports = ol.geom.Polygon;","module.exports = ol.geom.SimpleGeometry;","module.exports = ol.Overlay;","/**\n * @module olcs.util\n */\nconst exports = {};\n\n\n/**\n * Cast to object.\n * @param {Object} param\n * @return {Object}\n */\nexports.obj = function(param) {\n  return param;\n};\n\n\n/**\n * @type {boolean|undefined}\n * @private\n */\nexports.supportsImageRenderingPixelatedResult_ = undefined;\n\n\n/**\n * @type {string|undefined}\n * @private\n */\nexports.imageRenderingValueResult_ = undefined;\n\n\n/**\n * @return {boolean}\n */\nexports.supportsImageRenderingPixelated = function() {\n  if (exports.supportsImageRenderingPixelatedResult_ === undefined) {\n    const canvas = document.createElement('canvas');\n    canvas.setAttribute('style', 'image-rendering: -moz-crisp-edges; image-rendering: pixelated;');\n    // canvas.style.imageRendering will be undefined, null or an\n    // empty string on unsupported browsers.\n    const tmp = canvas.style['imageRendering']; // non standard\n    exports.supportsImageRenderingPixelatedResult_ = !!tmp;\n    if (exports.supportsImageRenderingPixelatedResult_) {\n      exports.imageRenderingValueResult_ = tmp;\n    }\n  }\n  return exports.supportsImageRenderingPixelatedResult_;\n};\n\n\n/**\n * @return {string}\n */\nexports.imageRenderingValue = function() {\n  exports.supportsImageRenderingPixelated();\n  return exports.imageRenderingValueResult_ || '';\n};\n\n/**\n * Return the projection of the source that Cesium should use.\n *\n * @param {ol.source.Source} source Source.\n * @returns {ol.proj.Projection} The projection of the source.\n */\nexports.getSourceProjection = function(source) {\n  return /** @type {ol.proj.Projection} */ (source.get('olcs.projection'))\n    || source.getProjection();\n};\n\n/**\n * @param {ol.Observable} observable\n * @param {string} type\n * @param {Function} listener\n * @return {!ol.events.EventsKey}\n */\nexport function olcsListen(observable, type, listener) {\n  // See https://github.com/openlayers/openlayers/pull/8481\n  // ol.events.listen is internal so we use `on` instead.\n  // And since `on` as a convoluted API (can return an EventsKey or an array of them)\n  // we use a cast here.\n  return /** @type {!ol.events.EventsKey} */ (observable.on(type, listener));\n}\n\n/**\n * Counter for getUid.\n * @type {number}\n */\nlet uidCounter_ = 0;\n\n/**\n * Gets a unique ID for an object. This mutates the object so that further calls\n * with the same object as a parameter returns the same value. Unique IDs are generated\n * as a strictly increasing sequence. Adapted from goog.getUid.\n *\n * @param {Object} obj The object to get the unique ID for.\n * @return {number} The unique ID for the object.\n */\nexport function getUid(obj) {\n  return obj.olcs_uid || (obj.olcs_uid = ++uidCounter_);\n}\n\n/**\n * Sort the passed array such that the relative order of equal elements is preverved.\n * See https://en.wikipedia.org/wiki/Sorting_algorithm#Stability for details.\n * @param {Array<*>} arr The array to sort (modifies original).\n * @param {!function(*, *): number} compareFnc Comparison function.\n */\nexport function stableSort(arr, compareFnc) {\n  const length = arr.length;\n  const tmp = Array(arr.length);\n  for (let i = 0; i < length; i++) {\n    tmp[i] = {index: i, value: arr[i]};\n  }\n  tmp.sort((a, b) => compareFnc(a.value, b.value) || a.index - b.index);\n  for (let i = 0; i < arr.length; i++) {\n    arr[i] = tmp[i].value;\n  }\n}\n\n/**\n * @param {Node} node The node to remove.\n * @returns {Node} The node that was removed or null.\n */\nexport function removeNode(node) {\n  return node && node.parentNode ? node.parentNode.removeChild(node) : null;\n}\n\n/**\n * @param {Node} node The node to remove the children from.\n */\nexport function removeChildren(node) {\n  while (node.lastChild) {\n    node.removeChild(node.lastChild);\n  }\n}\n\nexport default exports;\n","/**\n * @module olcs.core.OLImageryProvider\n */\nimport {get as getProjection} from 'ol/proj.js';\nimport olcsUtil from '../util.js';\n\nclass OLImageryProvider /* should not extend Cesium.ImageryProvider */ {\n  /**\n   * Special class derived from Cesium.ImageryProvider\n   * that is connected to the given ol.source.TileImage.\n   * @param {!ol.Map} olMap\n   * @param {!ol.source.TileImage} source\n   * @param {ol.proj.Projection=} opt_fallbackProj Projection to assume if the\n   *                                               projection of the source is not defined.\n   * @constructor\n   * @extends {Cesium.ImageryProvider}\n   */\n  constructor(olMap, source, opt_fallbackProj) {\n    // Do not extend or call super constructor from\n    // Cesium.ImageryProvider since this particular function is a\n    // 'non instanciable interface' which throws on instanciation.\n\n    /**\n     * @type {!ol.source.TileImage}\n     * @private\n     */\n    this.source_ = source;\n\n    /**\n     * @type {?ol.proj.Projection}\n     * @private\n     */\n    this.projection_ = null;\n\n    /**\n     * @type {?ol.proj.Projection}\n     * @private\n     */\n    this.fallbackProj_ = opt_fallbackProj || null;\n\n    /**\n     * @type {boolean}\n     * @private\n     */\n    this.ready_ = false;\n\n    /**\n     * @type {?Cesium.TilingScheme}\n     * @private\n     */\n    this.tilingScheme_ = null;\n\n    /**\n     * @type {?Cesium.Rectangle}\n     * @private\n     */\n    this.rectangle_ = null;\n\n    /**\n     * @type {!ol.Map}\n     * @private\n     */\n    this.map_ = olMap;\n\n    const proxy = this.source_.get('olcs.proxy');\n    if (proxy) {\n      if (typeof proxy === 'function') {\n        this.proxy_ = {\n          'getURL': proxy\n        };\n      } else if (typeof proxy === 'string') {\n        this.proxy_ = new Cesium.DefaultProxy(proxy);\n      }\n    }\n\n    this.errorEvent_ = new Cesium.Event();\n\n    this.emptyCanvas_ = document.createElement('canvas');\n    this.emptyCanvas_.width = 1;\n    this.emptyCanvas_.height = 1;\n\n    this.source_.on('change', (e) => {\n      this.handleSourceChanged_();\n    });\n    this.handleSourceChanged_();\n  }\n\n  /**\n   * Checks if the underlying source is ready and cached required data.\n   * @private\n   */\n  handleSourceChanged_(frameState) {\n    if (!this.ready_ && this.source_.getState() == 'ready') {\n      this.projection_ = olcsUtil.getSourceProjection(this.source_) || this.fallbackProj_;\n      if (this.projection_ == getProjection('EPSG:4326')) {\n        this.tilingScheme_ = new Cesium.GeographicTilingScheme();\n      } else if (this.projection_ == getProjection('EPSG:3857')) {\n        this.tilingScheme_ = new Cesium.WebMercatorTilingScheme();\n      } else {\n        return;\n      }\n      this.rectangle_ = this.tilingScheme_.rectangle;\n\n      this.ready_ = true;\n    }\n  }\n\n  /**\n   * Generates the proper attributions for a given position and zoom\n   * level.\n   * @export\n   * @override\n   */\n  getTileCredits(x, y, level) {\n    const olExtent = this.map_.getView().calculateExtent(this.map_.getSize());\n    const zoom = this.tilingScheme_ instanceof Cesium.GeographicTilingScheme ? level + 1 : level;\n\n    const frameState = {\n      viewState: {zoom},\n      extent: olExtent\n    };\n\n    const attributionsFunction = this.source_.getAttributions();\n    if (!attributionsFunction) {\n      return [];\n    }\n    let attributions = attributionsFunction(frameState);\n    if (!Array.isArray(attributions)) {\n      attributions = [attributions];\n    }\n\n    return attributions.map(html => new Cesium.Credit(html, true));\n  }\n\n  /**\n   * @export\n   * @override\n   */\n  requestImage(x, y, level) {\n    const tileUrlFunction = this.source_.getTileUrlFunction();\n    if (tileUrlFunction && this.projection_) {\n\n      // Perform mapping of Cesium tile coordinates to OpenLayers tile coordinates:\n      // 1) Cesium zoom level 0 is OpenLayers zoom level 1 for EPSG:4326\n      const z_ = this.tilingScheme_ instanceof Cesium.GeographicTilingScheme ? level + 1 : level;\n      // 2) OpenLayers tile coordinates increase from bottom to top\n      const y_ = -y - 1;\n\n      let url = tileUrlFunction.call(this.source_,\n          [z_, x, y_], 1, this.projection_);\n      if (this.proxy_) {\n        url = this.proxy_.getURL(url);\n      }\n      return url ? Cesium.ImageryProvider.loadImage(this, url) : this.emptyCanvas_;\n    } else {\n      // return empty canvas to stop Cesium from retrying later\n      return this.emptyCanvas_;\n    }\n  }\n}\n\n// definitions of getters that are required to be present\n// in the Cesium.ImageryProvider instance:\nObject.defineProperties(OLImageryProvider.prototype, {\n  'ready': {\n    'get': /** @this {olcs.core.OLImageryProvider} */\n        function() {return this.ready_;}\n  },\n\n  'rectangle': {\n    'get': /** @this {olcs.core.OLImageryProvider} */\n        function() {return this.rectangle_;}\n  },\n\n  'tileWidth': {\n    'get': /** @this {olcs.core.OLImageryProvider} */\n        function() {\n          const tg = this.source_.getTileGrid();\n          return tg ? (Array.isArray(tg.getTileSize(0)) ? tg.getTileSize(0)[0] : tg.getTileSize(0)) : 256;\n        }\n  },\n\n  'tileHeight': {\n    'get': /** @this {olcs.core.OLImageryProvider} */\n        function() {\n          const tg = this.source_.getTileGrid();\n          return tg ? (Array.isArray(tg.getTileSize(0)) ? tg.getTileSize(0)[1] : tg.getTileSize(0)) : 256;\n        }\n  },\n\n  'maximumLevel': {\n    'get': /** @this {olcs.core.OLImageryProvider} */\n        function() {\n          const tg = this.source_.getTileGrid();\n          return tg ? tg.getMaxZoom() : 18;\n        }\n  },\n\n  'minimumLevel': {\n    'get': /** @this {olcs.core.OLImageryProvider} */\n        function() {\n          // WARNING: Do not use the minimum level (at least until the extent is\n          // properly set). Cesium assumes the minimumLevel to contain only\n          // a few tiles and tries to load them all at once -- this can\n          // freeze and/or crash the browser !\n          return 0;\n          //var tg = this.source_.getTileGrid();\n          //return tg ? tg.getMinZoom() : 0;\n        }\n  },\n\n  'tilingScheme': {\n    'get': /** @this {olcs.core.OLImageryProvider} */\n        function() {return this.tilingScheme_;}\n  },\n\n  'tileDiscardPolicy': {\n    'get': function() {return undefined;}\n  },\n\n  'errorEvent': {\n    'get': /** @this {olcs.core.OLImageryProvider} */\n        function() {return this.errorEvent_;}\n  },\n\n  'proxy': {\n    'get': /** @this {olcs.core.OLImageryProvider} */\n        function() {return this.proxy_;}\n  },\n\n  'hasAlphaChannel': {\n    'get': function() {return true;}\n  },\n\n  'pickFeatures': {\n    'get': function() {return undefined;}\n  }\n});\n\n\nexport default OLImageryProvider;\n","/**\n * @module olcs.core\n */\nconst exports = {};\nimport {linear as linearEasing} from 'ol/easing.js';\nimport olLayerTile from 'ol/layer/Tile.js';\nimport olLayerImage from 'ol/layer/Image.js';\nimport {get as getProjection, transformExtent} from 'ol/proj.js';\nimport olSourceImageStatic from 'ol/source/ImageStatic';\nimport olSourceImageWMS from 'ol/source/ImageWMS.js';\nimport olSourceTileImage from 'ol/source/TileImage.js';\nimport olSourceTileWMS from 'ol/source/TileWMS.js';\nimport {defaultImageLoadFunction} from 'ol/source/Image.js';\nimport olcsCoreOLImageryProvider from './core/OLImageryProvider.js';\nimport olcsUtil from './util.js';\n\n\n/**\n * Compute the pixel width and height of a point in meters using the\n * camera frustum.\n * @param {!Cesium.Scene} scene\n * @param {!Cesium.Cartesian3} target\n * @return {!Cesium.Cartesian2} the pixel size\n * @api\n */\nexports.computePixelSizeAtCoordinate = function(scene, target) {\n  const camera = scene.camera;\n  const canvas = scene.canvas;\n  const frustum = camera.frustum;\n  const distance = Cesium.Cartesian3.magnitude(Cesium.Cartesian3.subtract(\n      camera.position, target, new Cesium.Cartesian3()));\n  const pixelSize = new Cesium.Cartesian2();\n  return frustum.getPixelDimensions(canvas.clientWidth, canvas.clientHeight,\n      distance, pixelSize);\n};\n\n\n/**\n * Compute bounding box around a target point.\n * @param {!Cesium.Scene} scene\n * @param {!Cesium.Cartesian3} target\n * @param {number} amount Half the side of the box, in pixels.\n * @return {Array<Cesium.Cartographic>} bottom left and top right\n * coordinates of the box\n */\nexports.computeBoundingBoxAtTarget = function(scene, target, amount) {\n  const pixelSize = exports.computePixelSizeAtCoordinate(scene, target);\n  const transform = Cesium.Transforms.eastNorthUpToFixedFrame(target);\n\n  const bottomLeft = Cesium.Matrix4.multiplyByPoint(\n      transform,\n      new Cesium.Cartesian3(-pixelSize.x * amount, -pixelSize.y * amount, 0),\n      new Cesium.Cartesian3());\n\n  const topRight = Cesium.Matrix4.multiplyByPoint(\n      transform,\n      new Cesium.Cartesian3(pixelSize.x * amount, pixelSize.y * amount, 0),\n      new Cesium.Cartesian3());\n\n  return Cesium.Ellipsoid.WGS84.cartesianArrayToCartographicArray(\n      [bottomLeft, topRight]);\n};\n\n\n/**\n *\n * @param {!ol.geom.Geometry} geometry\n * @param {number} height\n * @api\n */\nexports.applyHeightOffsetToGeometry = function(geometry, height) {\n  geometry.applyTransform((input, output, stride) => {\n    console.assert(input === output);\n    if (stride !== undefined && stride >= 3) {\n      for (let i = 0; i < output.length; i += stride) {\n        output[i + 2] = output[i + 2] + height;\n      }\n    }\n    return output;\n  });\n};\n\n\n/**\n * @param {ol.Coordinate} coordinates\n * @param {number=} rotation\n * @param {!Cesium.Cartesian3=} translation\n * @param {!Cesium.Cartesian3=} scale\n * @return {!Cesium.Matrix4}\n * @api\n */\nexports.createMatrixAtCoordinates = function(coordinates, rotation = 0, translation = Cesium.Cartesian3.ZERO, scale = new Cesium.Cartesian3(1, 1, 1)) {\n  const position = exports.ol4326CoordinateToCesiumCartesian(coordinates);\n  const rawMatrix = Cesium.Transforms.eastNorthUpToFixedFrame(position);\n  const quaternion = Cesium.Quaternion.fromAxisAngle(Cesium.Cartesian3.UNIT_Z, -rotation);\n  const rotationMatrix = Cesium.Matrix4.fromTranslationQuaternionRotationScale(translation, quaternion, scale);\n  return Cesium.Matrix4.multiply(rawMatrix, rotationMatrix, new Cesium.Matrix4());\n};\n\n\n/**\n * @param {!Cesium.Camera} camera\n * @param {number} angle\n * @param {!Cesium.Cartesian3} axis\n * @param {!Cesium.Matrix4} transform\n * @param {olcsx.core.RotateAroundAxisOption=} opt_options\n * @api\n */\nexports.rotateAroundAxis = function(camera, angle, axis, transform,\n    opt_options) {\n  const clamp = Cesium.Math.clamp;\n  const defaultValue = Cesium.defaultValue;\n\n  const options = opt_options || {};\n  const duration = defaultValue(options.duration, 500); // ms\n  const easing = defaultValue(options.easing, linearEasing);\n  const callback = options.callback;\n\n  let lastProgress = 0;\n  const oldTransform = new Cesium.Matrix4();\n\n  const start = Date.now();\n  const step = function() {\n    const timestamp = Date.now();\n    const timeDifference = timestamp - start;\n    const progress = easing(clamp(timeDifference / duration, 0, 1));\n    console.assert(progress >= lastProgress);\n\n    camera.transform.clone(oldTransform);\n    const stepAngle = (progress - lastProgress) * angle;\n    lastProgress = progress;\n    camera.lookAtTransform(transform);\n    camera.rotate(axis, stepAngle);\n    camera.lookAtTransform(oldTransform);\n\n    if (progress < 1) {\n      window.requestAnimationFrame(step);\n    } else {\n      if (callback) {\n        callback();\n      }\n    }\n  };\n  window.requestAnimationFrame(step);\n};\n\n\n/**\n * @param {!Cesium.Scene} scene\n * @param {number} heading\n * @param {!Cesium.Cartesian3} bottomCenter\n * @param {olcsx.core.RotateAroundAxisOption=} opt_options\n * @api\n */\nexports.setHeadingUsingBottomCenter = function(scene, heading,\n    bottomCenter, opt_options) {\n  const camera = scene.camera;\n  // Compute the camera position to zenith quaternion\n  const angleToZenith = exports.computeAngleToZenith(scene, bottomCenter);\n  const axis = camera.right;\n  const quaternion = Cesium.Quaternion.fromAxisAngle(axis, angleToZenith);\n  const rotation = Cesium.Matrix3.fromQuaternion(quaternion);\n\n  // Get the zenith point from the rotation of the position vector\n  const vector = new Cesium.Cartesian3();\n  Cesium.Cartesian3.subtract(camera.position, bottomCenter, vector);\n  const zenith = new Cesium.Cartesian3();\n  Cesium.Matrix3.multiplyByVector(rotation, vector, zenith);\n  Cesium.Cartesian3.add(zenith, bottomCenter, zenith);\n\n  // Actually rotate around the zenith normal\n  const transform = Cesium.Matrix4.fromTranslation(zenith);\n  const rotateAroundAxis = exports.rotateAroundAxis;\n  rotateAroundAxis(camera, heading, zenith, transform, opt_options);\n};\n\n\n/**\n * Get the 3D position of the given pixel of the canvas.\n * @param {!Cesium.Scene} scene\n * @param {!Cesium.Cartesian2} pixel\n * @return {!Cesium.Cartesian3|undefined}\n * @api\n */\nexports.pickOnTerrainOrEllipsoid = function(scene, pixel) {\n  const ray = scene.camera.getPickRay(pixel);\n  const target = scene.globe.pick(ray, scene);\n  return target || scene.camera.pickEllipsoid(pixel);\n};\n\n\n/**\n * Get the 3D position of the point at the bottom-center of the screen.\n * @param {!Cesium.Scene} scene\n * @return {!Cesium.Cartesian3|undefined}\n * @api\n */\nexports.pickBottomPoint = function(scene) {\n  const canvas = scene.canvas;\n  const bottom = new Cesium.Cartesian2(\n      canvas.clientWidth / 2, canvas.clientHeight);\n  return exports.pickOnTerrainOrEllipsoid(scene, bottom);\n};\n\n\n/**\n * Get the 3D position of the point at the center of the screen.\n * @param {!Cesium.Scene} scene\n * @return {!Cesium.Cartesian3|undefined}\n * @api\n */\nexports.pickCenterPoint = function(scene) {\n  const canvas = scene.canvas;\n  const center = new Cesium.Cartesian2(\n      canvas.clientWidth / 2,\n      canvas.clientHeight / 2);\n  return exports.pickOnTerrainOrEllipsoid(scene, center);\n};\n\n\n/**\n * Compute the signed tilt angle on globe, between the opposite of the\n * camera direction and the target normal. Return undefined if there is no\n * intersection of the camera direction with the globe.\n * @param {!Cesium.Scene} scene\n * @return {number|undefined}\n * @api\n */\nexports.computeSignedTiltAngleOnGlobe = function(scene) {\n  const camera = scene.camera;\n  const ray = new Cesium.Ray(camera.position, camera.direction);\n  let target = scene.globe.pick(ray, scene);\n\n  if (!target) {\n    // no tiles in the area were loaded?\n    const ellipsoid = Cesium.Ellipsoid.WGS84;\n    const obj = Cesium.IntersectionTests.rayEllipsoid(ray, ellipsoid);\n    if (obj) {\n      target = Cesium.Ray.getPoint(ray, obj.start);\n    }\n  }\n\n  if (!target) {\n    return undefined;\n  }\n\n  const normal = new Cesium.Cartesian3();\n  Cesium.Ellipsoid.WGS84.geocentricSurfaceNormal(target, normal);\n\n  const angleBetween = exports.signedAngleBetween;\n  const angle = angleBetween(camera.direction, normal, camera.right) - Math.PI;\n  return Cesium.Math.convertLongitudeRange(angle);\n};\n\n\n/**\n * Compute the ray from the camera to the bottom-center of the screen.\n * @param {!Cesium.Scene} scene\n * @return {!Cesium.Ray}\n */\nexports.bottomFovRay = function(scene) {\n  const camera = scene.camera;\n  const fovy2 = camera.frustum.fovy / 2;\n  const direction = camera.direction;\n  const rotation = Cesium.Quaternion.fromAxisAngle(camera.right, fovy2);\n  const matrix = Cesium.Matrix3.fromQuaternion(rotation);\n  const vector = new Cesium.Cartesian3();\n  Cesium.Matrix3.multiplyByVector(matrix, direction, vector);\n  return new Cesium.Ray(camera.position, vector);\n};\n\n\n/**\n * Compute the angle between two Cartesian3.\n * @param {!Cesium.Cartesian3} first\n * @param {!Cesium.Cartesian3} second\n * @param {!Cesium.Cartesian3} normal Normal to test orientation against.\n * @return {number}\n */\nexports.signedAngleBetween = function(first, second, normal) {\n  // We are using the dot for the angle.\n  // Then the cross and the dot for the sign.\n  const a = new Cesium.Cartesian3();\n  const b = new Cesium.Cartesian3();\n  const c = new Cesium.Cartesian3();\n  Cesium.Cartesian3.normalize(first, a);\n  Cesium.Cartesian3.normalize(second, b);\n  Cesium.Cartesian3.cross(a, b, c);\n\n  const cosine = Cesium.Cartesian3.dot(a, b);\n  const sine = Cesium.Cartesian3.magnitude(c);\n\n  // Sign of the vector product and the orientation normal\n  const sign = Cesium.Cartesian3.dot(normal, c);\n  const angle = Math.atan2(sine, cosine);\n  return sign >= 0 ? angle : -angle;\n};\n\n\n/**\n * Compute the rotation angle around a given point, needed to reach the\n * zenith position.\n * At a zenith position, the camera direction is going througth the earth\n * center and the frustrum bottom ray is going through the chosen pivot\n * point.\n * The bottom-center of the screen is a good candidate for the pivot point.\n * @param {!Cesium.Scene} scene\n * @param {!Cesium.Cartesian3} pivot Point around which the camera rotates.\n * @return {number}\n * @api\n */\nexports.computeAngleToZenith = function(scene, pivot) {\n  // This angle is the sum of the angles 'fy' and 'a', which are defined\n  // using the pivot point and its surface normal.\n  //        Zenith |    camera\n  //           \\   |   /\n  //            \\fy|  /\n  //             \\ |a/\n  //              \\|/pivot\n  const camera = scene.camera;\n  const fy = camera.frustum.fovy / 2;\n  const ray = exports.bottomFovRay(scene);\n  const direction = Cesium.Cartesian3.clone(ray.direction);\n  Cesium.Cartesian3.negate(direction, direction);\n\n  const normal = new Cesium.Cartesian3();\n  Cesium.Ellipsoid.WGS84.geocentricSurfaceNormal(pivot, normal);\n\n  const left = new Cesium.Cartesian3();\n  Cesium.Cartesian3.negate(camera.right, left);\n\n  const a = exports.signedAngleBetween(normal, direction, left);\n  return a + fy;\n};\n\n\n/**\n * Convert an OpenLayers extent to a Cesium rectangle.\n * @param {ol.Extent} extent Extent.\n * @param {ol.ProjectionLike} projection Extent projection.\n * @return {Cesium.Rectangle} The corresponding Cesium rectangle.\n * @api\n */\nexports.extentToRectangle = function(extent, projection) {\n  if (extent && projection) {\n    const ext = transformExtent(extent, projection, 'EPSG:4326');\n    return Cesium.Rectangle.fromDegrees(ext[0], ext[1], ext[2], ext[3]);\n  } else {\n    return null;\n  }\n};\n\n\n/**\n * Creates Cesium.ImageryLayer best corresponding to the given ol.layer.Layer.\n * Only supports raster layers and static images\n * @param {!ol.Map} olMap\n * @param {!ol.layer.Base} olLayer\n * @param {!ol.proj.Projection} viewProj Projection of the view.\n * @return {?Cesium.ImageryLayer} null if not possible (or supported)\n * @api\n */\nexports.tileLayerToImageryLayer = function(olMap, olLayer, viewProj) {\n\n  if (!(olLayer instanceof olLayerTile) && !(olLayer instanceof olLayerImage)) {\n    return null;\n  }\n\n  let provider = null;\n  let source = olLayer.getSource();\n\n  // Convert ImageWMS to TileWMS\n  if (source instanceof olSourceImageWMS && source.getUrl() &&\n    source.getImageLoadFunction() === defaultImageLoadFunction) {\n    const sourceProps = {\n      'olcs.proxy': source.get('olcs.proxy'),\n      'olcs.extent': source.get('olcs.extent'),\n      'olcs.projection': source.get('olcs.projection'),\n      'olcs.imagesource': source\n    };\n    source = new olSourceTileWMS({\n      url: source.getUrl(),\n      attributions: source.getAttributions(),\n      projection: source.getProjection(),\n      params: source.getParams()\n    });\n    source.setProperties(sourceProps);\n  }\n\n  if (source instanceof olSourceTileImage) {\n    let projection = olcsUtil.getSourceProjection(source);\n\n    if (!projection) {\n      // if not explicit, assume the same projection as view\n      projection = viewProj;\n    }\n\n    if (exports.isCesiumProjection(projection)) {\n      provider = new olcsCoreOLImageryProvider(olMap, source, viewProj);\n    }\n    // Projection not supported by Cesium\n    else {\n      return null;\n    }\n\n  } else if (source instanceof olSourceImageStatic) {\n    let projection = olcsUtil.getSourceProjection(source);\n\n    if (!projection) {\n      projection = viewProj;\n    }\n\n    if (exports.isCesiumProjection(projection)) {\n      provider = new Cesium.SingleTileImageryProvider({\n        url: source.getUrl(),\n        rectangle: new Cesium.Rectangle.fromDegrees(\n            source.getImageExtent()[0],\n            source.getImageExtent()[1],\n            source.getImageExtent()[2],\n            source.getImageExtent()[3]\n        )\n      });\n    }\n    // Projection not supported by Cesium\n    else {\n      return null;\n    }\n  } else {\n    // sources other than TileImage|ImageStatic are currently not supported\n    return null;\n  }\n\n  // the provider is always non-null if we got this far\n\n  const layerOptions = {};\n\n  const forcedExtent = /** @type {ol.Extent} */ (olLayer.get('olcs.extent'));\n  const ext = forcedExtent || olLayer.getExtent();\n  if (ext) {\n    layerOptions.rectangle = exports.extentToRectangle(ext, viewProj);\n  }\n\n  const cesiumLayer = new Cesium.ImageryLayer(provider, layerOptions);\n  return cesiumLayer;\n};\n\n\n/**\n * Synchronizes the layer rendering properties (opacity, visible)\n * to the given Cesium ImageryLayer.\n * @param {olcsx.LayerWithParents} olLayerWithParents\n * @param {!Cesium.ImageryLayer} csLayer\n * @api\n */\nexports.updateCesiumLayerProperties = function(olLayerWithParents, csLayer) {\n  let opacity = 1;\n  let visible = true;\n  [olLayerWithParents.layer].concat(olLayerWithParents.parents).forEach((olLayer) => {\n    const layerOpacity = olLayer.getOpacity();\n    if (layerOpacity !== undefined) {\n      opacity *= layerOpacity;\n    }\n    const layerVisible = olLayer.getVisible();\n    if (layerVisible !== undefined) {\n      visible &= layerVisible;\n    }\n  });\n  csLayer.alpha = opacity;\n  csLayer.show = visible;\n};\n\n\n/**\n * Convert a 2D or 3D OpenLayers coordinate to Cesium.\n * @param {ol.Coordinate} coordinate Ol3 coordinate.\n * @return {!Cesium.Cartesian3} Cesium cartesian coordinate\n * @api\n */\nexports.ol4326CoordinateToCesiumCartesian = function(coordinate) {\n  const coo = coordinate;\n  return coo.length > 2 ?\n    Cesium.Cartesian3.fromDegrees(coo[0], coo[1], coo[2]) :\n    Cesium.Cartesian3.fromDegrees(coo[0], coo[1]);\n};\n\n\n/**\n * Convert an array of 2D or 3D OpenLayers coordinates to Cesium.\n * @param {Array.<!ol.Coordinate>} coordinates Ol3 coordinates.\n * @return {!Array.<Cesium.Cartesian3>} Cesium cartesian coordinates\n * @api\n */\nexports.ol4326CoordinateArrayToCsCartesians = function(coordinates) {\n  console.assert(coordinates !== null);\n  const toCartesian = exports.ol4326CoordinateToCesiumCartesian;\n  const cartesians = [];\n  for (let i = 0; i < coordinates.length; ++i) {\n    cartesians.push(toCartesian(coordinates[i]));\n  }\n  return cartesians;\n};\n\n\n/**\n * Reproject an OpenLayers geometry to EPSG:4326 if needed.\n * The geometry will be cloned only when original projection is not EPSG:4326\n * and the properties will be shallow copied.\n * @param {!T} geometry\n * @param {!ol.ProjectionLike} projection\n * @return {!T}\n * @template T\n * @api\n */\nexports.olGeometryCloneTo4326 = function(geometry, projection) {\n  console.assert(projection);\n\n  const proj4326 = getProjection('EPSG:4326');\n  const proj = getProjection(projection);\n  if (proj !== proj4326) {\n    const properties = geometry.getProperties();\n    geometry = geometry.clone();\n    geometry.transform(proj, proj4326);\n    geometry.setProperties(properties);\n  }\n  return geometry;\n};\n\n\n/**\n * Convert an OpenLayers color to Cesium.\n * @param {ol.Color|CanvasGradient|CanvasPattern|string} olColor\n * @return {!Cesium.Color}\n * @api\n */\nexports.convertColorToCesium = function(olColor) {\n  olColor = olColor || 'black';\n  if (Array.isArray(olColor)) {\n    return new Cesium.Color(\n        Cesium.Color.byteToFloat(olColor[0]),\n        Cesium.Color.byteToFloat(olColor[1]),\n        Cesium.Color.byteToFloat(olColor[2]),\n        olColor[3]\n    );\n  } else if (typeof olColor == 'string') {\n    return Cesium.Color.fromCssColorString(olColor);\n  } else if (olColor instanceof CanvasPattern || olColor instanceof CanvasGradient) {\n    // Render the CanvasPattern/CanvasGradient into a canvas that will be sent to Cesium as material\n    const canvas = document.createElement('canvas');\n    const ctx = canvas.getContext('2d');\n    canvas.width = canvas.height = 256;\n    ctx.fillStyle = olColor;\n    ctx.fillRect(0, 0, canvas.width, canvas.height);\n    return new Cesium.ImageMaterialProperty({\n      image: canvas\n    });\n  }\n  console.assert(false, 'impossible');\n};\n\n\n/**\n * Convert an OpenLayers url to Cesium.\n * @param {string} url\n * @return {!olcsx.core.CesiumUrlDefinition}\n * @api\n */\nexports.convertUrlToCesium = function(url) {\n  let subdomains = '';\n  const re = /\\{(\\d|[a-z])-(\\d|[a-z])\\}/;\n  const match = re.exec(url);\n  if (match) {\n    url = url.replace(re, '{s}');\n    const startCharCode = match[1].charCodeAt(0);\n    const stopCharCode = match[2].charCodeAt(0);\n    let charCode;\n    for (charCode = startCharCode; charCode <= stopCharCode; ++charCode) {\n      subdomains += String.fromCharCode(charCode);\n    }\n  }\n  return {\n    url,\n    subdomains\n  };\n};\n\n\n/**\n * Animate the return to a top-down view from the zenith.\n * The camera is rotated to orient to the North.\n * @param {!ol.Map} map\n * @param {!Cesium.Scene} scene\n * @return {Promise<undefined>}\n * @api\n */\nexports.resetToNorthZenith = function(map, scene) {\n  return new Promise((resolve, reject) => {\n    const camera = scene.camera;\n    const pivot = exports.pickBottomPoint(scene);\n    if (!pivot) {\n      reject('Could not get bottom pivot');\n      return;\n    }\n\n    const currentHeading = map.getView().getRotation();\n    if (currentHeading === undefined) {\n      reject('The view is not initialized');\n      return;\n    }\n    const angle = exports.computeAngleToZenith(scene, pivot);\n\n    // Point to North\n    exports.setHeadingUsingBottomCenter(scene, currentHeading, pivot);\n\n    // Go to zenith\n    const transform = Cesium.Matrix4.fromTranslation(pivot);\n    const axis = camera.right;\n    const options = {\n      callback: () => {\n        const view = map.getView();\n        exports.normalizeView(view);\n        resolve();\n      }\n    };\n    exports.rotateAroundAxis(camera, -angle, axis, transform, options);\n  });\n};\n\n\n/**\n * @param {!Cesium.Scene} scene\n * @param {number} angle in radian\n * @return {Promise<undefined>}\n * @api\n */\nexports.rotateAroundBottomCenter = function(scene, angle) {\n  return new Promise((resolve, reject) => {\n    const camera = scene.camera;\n    const pivot = exports.pickBottomPoint(scene);\n    if (!pivot) {\n      reject('could not get bottom pivot');\n      return;\n    }\n\n    const options = {callback: resolve};\n    const transform = Cesium.Matrix4.fromTranslation(pivot);\n    const axis = camera.right;\n    const rotateAroundAxis = exports.rotateAroundAxis;\n    rotateAroundAxis(camera, -angle, axis, transform, options);\n  });\n};\n\n\n/**\n * Set the OpenLayers view to a specific rotation and\n * the nearest resolution.\n * @param {ol.View} view\n * @param {number=} angle\n * @api\n */\nexports.normalizeView = function(view, angle = 0) {\n  const resolution = view.getResolution();\n  view.setRotation(angle);\n  view.setResolution(view.constrainResolution(resolution));\n};\n\n/**\n * Check if the given projection is managed by Cesium (WGS84 or Mercator Spheric)\n *\n * @param {ol.proj.Projection} projection Projection to check.\n * @returns {boolean} Whether it's managed by Cesium.\n */\nexports.isCesiumProjection = function(projection) {\n  const is3857 = projection === getProjection('EPSG:3857');\n  const is4326 = projection === getProjection('EPSG:4326');\n  return is3857 || is4326;\n};\n\n\nexport default exports;\n","/**\n * @module olcs.AutoRenderLoop\n */\n\nclass AutoRenderLoop {\n  /**\n   * @constructor\n   * @param {olcs.OLCesium} ol3d\n   */\n  constructor(ol3d) {\n    this.ol3d = ol3d;\n    this.scene_ = ol3d.getCesiumScene();\n    this.canvas_ = this.scene_.canvas;\n    this._boundNotifyRepaintRequired = this.notifyRepaintRequired.bind(this);\n\n    this.repaintEventNames_ = [\n      'mousemove', 'mousedown', 'mouseup',\n      'touchstart', 'touchend', 'touchmove',\n      'pointerdown', 'pointerup', 'pointermove',\n      'wheel'\n    ];\n\n    this.enable();\n  }\n\n  /**\n   * Enable.\n   */\n  enable() {\n    this.scene_.requestRenderMode = true;\n    this.scene_.maximumRenderTimeChange = 1000;\n    for (const repaintKey of this.repaintEventNames_) {\n      this.canvas_.addEventListener(repaintKey, this._boundNotifyRepaintRequired, false);\n    }\n\n    window.addEventListener('resize', this._boundNotifyRepaintRequired, false);\n\n    // Listen for changes on the layer group\n    this.ol3d.getOlMap().getLayerGroup().on('change', this._boundNotifyRepaintRequired);\n  }\n\n  /**\n   * Disable.\n   */\n  disable() {\n    for (const repaintKey of this.repaintEventNames_) {\n      this.canvas_.removeEventListener(repaintKey, this._boundNotifyRepaintRequired, false);\n    }\n\n    window.removeEventListener('resize', this._boundNotifyRepaintRequired, false);\n\n    this.ol3d.getOlMap().getLayerGroup().un('change', this._boundNotifyRepaintRequired);\n    this.scene_.requestRenderMode = false;\n  }\n\n  /**\n   * Restart render loop.\n   * Force a restart of the render loop.\n   * @api\n   */\n  restartRenderLoop() {\n    this.notifyRepaintRequired();\n  }\n\n  notifyRepaintRequired() {\n    this.scene_.requestRender();\n  }\n}\n\n\nexport default AutoRenderLoop;\n","/**\n * Converts radians to to degrees.\n *\n * @param {number} angleInRadians Angle in radians.\n * @return {number} Angle in degrees.\n */\nexport function toDegrees(angleInRadians) {\n  return angleInRadians * 180 / Math.PI;\n}\n\n\n/**\n * Converts degrees to radians.\n *\n * @param {number} angleInDegrees Angle in degrees.\n * @return {number} Angle in radians.\n */\nexport function toRadians(angleInDegrees) {\n  return angleInDegrees * Math.PI / 180;\n}\n","/**\n * @module olcs.Camera\n */\n\nimport {unByKey as olObservableUnByKey} from 'ol/Observable.js';\nimport {toRadians, toDegrees} from './math.js';\nimport {getTransform} from 'ol/proj.js';\nimport olcsCore from './core.js';\n\nclass Camera {\n  /**\n   * This object takes care of additional 3d-specific properties of the view and\n   * ensures proper synchronization with the underlying raw Cesium.Camera object.\n   * @param {!Cesium.Scene} scene\n   * @param {!ol.Map} map\n   * @api\n   */\n  constructor(scene, map) {\n    /**\n     * @type {!Cesium.Scene}\n     * @private\n     */\n    this.scene_ = scene;\n\n    /**\n     * @type {!Cesium.Camera}\n     * @private\n     */\n    this.cam_ = scene.camera;\n\n    /**\n     * @type {!ol.Map}\n     * @private\n     */\n    this.map_ = map;\n\n    /**\n     * @type {?ol.View}\n     * @private\n     */\n    this.view_ = null;\n\n    /**\n     * @type {?ol.EventsKey}\n     * @private\n     */\n    this.viewListenKey_ = null;\n\n    /**\n     * @type {!ol.TransformFunction}\n     * @private\n     */\n    this.toLonLat_ = Camera.identityProjection;\n\n    /**\n     * @type {!ol.TransformFunction}\n     * @private\n     */\n    this.fromLonLat_ = Camera.identityProjection;\n\n    /**\n     * 0 -- topdown, PI/2 -- the horizon\n     * @type {number}\n     * @private\n     */\n    this.tilt_ = 0;\n\n    /**\n     * @type {number}\n     * @private\n     */\n    this.distance_ = 0;\n\n    /**\n     * @type {?Cesium.Matrix4}\n     * @private\n     */\n    this.lastCameraViewMatrix_ = null;\n\n    /**\n     * This is used to discard change events on view caused by updateView method.\n     * @type {boolean}\n     * @private\n     */\n    this.viewUpdateInProgress_ = false;\n\n    this.map_.on('change:view', (e) => {\n      this.setView_(this.map_.getView());\n    });\n    this.setView_(this.map_.getView());\n  }\n\n  /**\n   * @param {Array.<number>} input Input coordinate array.\n   * @param {Array.<number>=} opt_output Output array of coordinate values.\n   * @param {number=} opt_dimension Dimension.\n   * @return {Array.<number>} Input coordinate array (same array as input).\n   */\n  static identityProjection(input, opt_output, opt_dimension) {\n    const dim = opt_dimension || input.length;\n    if (opt_output) {\n      for (let i = 0; i < dim; ++i) {\n        opt_output[i] = input[i];\n      }\n    }\n    return input;\n  }\n\n  /**\n   * @param {?ol.View} view New view to use.\n   * @private\n   */\n  setView_(view) {\n    if (this.view_) {\n      olObservableUnByKey(this.viewListenKey_);\n      this.viewListenKey_ = null;\n    }\n\n    this.view_ = view;\n    if (view) {\n      const toLonLat = getTransform(view.getProjection(), 'EPSG:4326');\n      const fromLonLat = getTransform('EPSG:4326', view.getProjection());\n      console.assert(toLonLat && fromLonLat);\n\n      this.toLonLat_ = toLonLat;\n      this.fromLonLat_ = fromLonLat;\n\n      this.viewListenKey_ = view.on('propertychange', e => this.handleViewEvent_(e));\n\n      this.readFromView();\n    } else {\n      this.toLonLat_ = Camera.identityProjection;\n      this.fromLonLat_ = Camera.identityProjection;\n    }\n  }\n\n  /**\n   * @param {?} e\n   * @private\n   */\n  handleViewEvent_(e) {\n    if (!this.viewUpdateInProgress_) {\n      this.readFromView();\n    }\n  }\n\n  /**\n   * @param {number} heading In radians.\n   * @api\n   */\n  setHeading(heading) {\n    if (!this.view_) {\n      return;\n    }\n\n    this.view_.setRotation(heading);\n  }\n\n  /**\n   * @return {number|undefined} Heading in radians.\n   * @api\n   */\n  getHeading() {\n    if (!this.view_) {\n      return undefined;\n    }\n    const rotation = this.view_.getRotation();\n    return rotation || 0;\n  }\n\n  /**\n   * @param {number} tilt In radians.\n   * @api\n   */\n  setTilt(tilt) {\n    this.tilt_ = tilt;\n    this.updateCamera_();\n  }\n\n  /**\n   * @return {number} Tilt in radians.\n   * @api\n   */\n  getTilt() {\n    return this.tilt_;\n  }\n\n  /**\n   * @param {number} distance In meters.\n   * @api\n   */\n  setDistance(distance) {\n    this.distance_ = distance;\n    this.updateCamera_();\n    this.updateView();\n  }\n\n  /**\n   * @return {number} Distance in meters.\n   * @api\n   */\n  getDistance() {\n    return this.distance_;\n  }\n\n  /**\n   * Shortcut for ol.View.setCenter().\n   * @param {!ol.Coordinate} center Same projection as the ol.View.\n   * @api\n   */\n  setCenter(center) {\n    if (!this.view_) {\n      return;\n    }\n    this.view_.setCenter(center);\n  }\n\n  /**\n   * Shortcut for ol.View.getCenter().\n   * @return {ol.Coordinate|undefined} Same projection as the ol.View.\n   * @api\n   */\n  getCenter() {\n    if (!this.view_) {\n      return undefined;\n    }\n    return this.view_.getCenter();\n  }\n\n  /**\n   * Sets the position of the camera.\n   * @param {!ol.Coordinate} position Same projection as the ol.View.\n   * @api\n   */\n  setPosition(position) {\n    if (!this.toLonLat_) {\n      return;\n    }\n    const ll = this.toLonLat_(position);\n    console.assert(ll);\n\n    const carto = new Cesium.Cartographic(\n        toRadians(ll[0]),\n        toRadians(ll[1]),\n        this.getAltitude());\n\n    this.cam_.setView({\n      destination: Cesium.Ellipsoid.WGS84.cartographicToCartesian(carto)\n    });\n    this.updateView();\n  }\n\n  /**\n   * Calculates position under the camera.\n   * @return {!ol.Coordinate|undefined} Same projection as the ol.View.\n   * @api\n   */\n  getPosition() {\n    if (!this.fromLonLat_) {\n      return undefined;\n    }\n    const carto = Cesium.Ellipsoid.WGS84.cartesianToCartographic(this.cam_.position);\n\n    const pos = this.fromLonLat_([\n      toDegrees(carto.longitude),\n      toDegrees(carto.latitude)\n    ]);\n    console.assert(pos);\n    return pos;\n  }\n\n  /**\n   * @param {number} altitude In meters.\n   * @api\n   */\n  setAltitude(altitude) {\n    const carto = Cesium.Ellipsoid.WGS84.cartesianToCartographic(\n        this.cam_.position);\n    carto.height = altitude;\n    this.cam_.position = Cesium.Ellipsoid.WGS84.cartographicToCartesian(carto);\n\n    this.updateView();\n  }\n\n  /**\n   * @return {number} Altitude in meters.\n   * @api\n   */\n  getAltitude() {\n    const carto = Cesium.Ellipsoid.WGS84.cartesianToCartographic(\n        this.cam_.position);\n\n    return carto.height;\n  }\n\n  /**\n   * Updates the state of the underlying Cesium.Camera\n   * according to the current values of the properties.\n   * @private\n   */\n  updateCamera_() {\n    if (!this.view_ || !this.toLonLat_) {\n      return;\n    }\n    const center = this.view_.getCenter();\n    if (!center) {\n      return;\n    }\n    const ll = this.toLonLat_(center);\n    console.assert(ll);\n\n    const carto = new Cesium.Cartographic(toRadians(ll[0]),\n        toRadians(ll[1]));\n    if (this.scene_.globe) {\n      const height = this.scene_.globe.getHeight(carto);\n      carto.height = height || 0;\n    }\n\n    const destination = Cesium.Ellipsoid.WGS84.cartographicToCartesian(carto);\n\n    /** @type {Cesium.optionsOrientation} */\n    const orientation = {\n      pitch: this.tilt_ - Cesium.Math.PI_OVER_TWO,\n      heading: -this.view_.getRotation(),\n      roll: undefined\n    };\n    this.cam_.setView({\n      destination,\n      orientation\n    });\n\n    this.cam_.moveBackward(this.distance_);\n\n    this.checkCameraChange(true);\n  }\n\n  /**\n   * Calculates the values of the properties from the current ol.View state.\n   * @api\n   */\n  readFromView() {\n    if (!this.view_ || !this.toLonLat_) {\n      return;\n    }\n    const center = this.view_.getCenter();\n    if (center === undefined || center === null) {\n      return;\n    }\n    const ll = this.toLonLat_(center);\n    console.assert(ll);\n\n    const resolution = this.view_.getResolution();\n    this.distance_ = this.calcDistanceForResolution(\n        resolution || 0, toRadians(ll[1]));\n\n    this.updateCamera_();\n  }\n\n  /**\n   * Calculates the values of the properties from the current Cesium.Camera state.\n   * Modifies the center, resolution and rotation properties of the view.\n   * @api\n   */\n  updateView() {\n    if (!this.view_ || !this.fromLonLat_) {\n      return;\n    }\n    this.viewUpdateInProgress_ = true;\n\n    // target & distance\n    const ellipsoid = Cesium.Ellipsoid.WGS84;\n    const scene = this.scene_;\n    const target = olcsCore.pickCenterPoint(scene);\n\n    let bestTarget = target;\n    if (!bestTarget) {\n      //TODO: how to handle this properly ?\n      const globe = scene.globe;\n      const carto = this.cam_.positionCartographic.clone();\n      const height = globe.getHeight(carto);\n      carto.height = height || 0;\n      bestTarget = Cesium.Ellipsoid.WGS84.cartographicToCartesian(carto);\n    }\n    this.distance_ = Cesium.Cartesian3.distance(bestTarget, this.cam_.position);\n    const bestTargetCartographic = ellipsoid.cartesianToCartographic(bestTarget);\n    this.view_.setCenter(this.fromLonLat_([\n      toDegrees(bestTargetCartographic.longitude),\n      toDegrees(bestTargetCartographic.latitude)]));\n\n    // resolution\n    this.view_.setResolution(\n        this.calcResolutionForDistance(this.distance_,\n            bestTargetCartographic ? bestTargetCartographic.latitude : 0));\n\n\n    /*\n     * Since we are positioning the target, the values of heading and tilt\n     * need to be calculated _at the target_.\n     */\n    if (target) {\n      const pos = this.cam_.position;\n\n      // normal to the ellipsoid at the target\n      const targetNormal = new Cesium.Cartesian3();\n      ellipsoid.geocentricSurfaceNormal(target, targetNormal);\n\n      // vector from the target to the camera\n      const targetToCamera = new Cesium.Cartesian3();\n      Cesium.Cartesian3.subtract(pos, target, targetToCamera);\n      Cesium.Cartesian3.normalize(targetToCamera, targetToCamera);\n\n\n      // HEADING\n      const up = this.cam_.up;\n      const right = this.cam_.right;\n      const normal = new Cesium.Cartesian3(-target.y, target.x, 0); // what is it?\n      const heading = Cesium.Cartesian3.angleBetween(right, normal);\n      const cross = Cesium.Cartesian3.cross(target, up, new Cesium.Cartesian3());\n      const orientation = cross.z;\n\n      this.view_.setRotation((orientation < 0 ? heading : -heading));\n\n      // TILT\n      const tiltAngle = Math.acos(\n          Cesium.Cartesian3.dot(targetNormal, targetToCamera));\n      this.tilt_ = isNaN(tiltAngle) ? 0 : tiltAngle;\n    } else {\n      // fallback when there is no target\n      this.view_.setRotation(this.cam_.heading);\n      this.tilt_ = -this.cam_.pitch + Math.PI / 2;\n    }\n\n    this.viewUpdateInProgress_ = false;\n  }\n\n  /**\n   * Check if the underlying camera state has changed and ensure synchronization.\n   * @param {boolean=} opt_dontSync Do not synchronize the view.\n   */\n  checkCameraChange(opt_dontSync) {\n    const old = this.lastCameraViewMatrix_;\n    const current = this.cam_.viewMatrix;\n\n    if (!old || !Cesium.Matrix4.equalsEpsilon(old, current, 1e-5)) {\n      this.lastCameraViewMatrix_ = current.clone();\n      if (opt_dontSync !== true) {\n        this.updateView();\n      }\n    }\n  }\n\n  /**\n   * calculate the distance between camera and centerpoint based on the resolution and latitude value\n   * @param {number} resolution Number of map units per pixel.\n   * @param {number} latitude Latitude in radians.\n   * @return {number} The calculated distance.\n   * @api\n   */\n  calcDistanceForResolution(resolution, latitude) {\n    const canvas = this.scene_.canvas;\n    const fovy = this.cam_.frustum.fovy; // vertical field of view\n    console.assert(!isNaN(fovy));\n    const metersPerUnit = this.view_.getProjection().getMetersPerUnit();\n\n    // number of \"map units\" visible in 2D (vertically)\n    const visibleMapUnits = resolution * canvas.clientHeight;\n\n    // The metersPerUnit does not take latitude into account, but it should\n    // be lower with increasing latitude -- we have to compensate.\n    // In 3D it is not possible to maintain the resolution at more than one point,\n    // so it only makes sense to use the latitude of the \"target\" point.\n    const relativeCircumference = Math.cos(Math.abs(latitude));\n\n    // how many meters should be visible in 3D\n    const visibleMeters = visibleMapUnits * metersPerUnit * relativeCircumference;\n\n    // distance required to view the calculated length in meters\n    //\n    //  fovy/2\n    //    |\\\n    //  x | \\\n    //    |--\\\n    // visibleMeters/2\n    const requiredDistance = (visibleMeters / 2) / Math.tan(fovy / 2);\n\n    // NOTE: This calculation is not absolutely precise, because metersPerUnit\n    // is a great simplification. It does not take ellipsoid/terrain into account.\n\n    return requiredDistance;\n  }\n\n  /**\n   * calculate the resolution based on a distance(camera to position) and latitude value\n   * @param {number} distance\n   * @param {number} latitude\n   * @return {number} The calculated resolution.\n   * @api\n   */\n  calcResolutionForDistance(distance, latitude) {\n    // See the reverse calculation (calcDistanceForResolution) for details\n    const canvas = this.scene_.canvas;\n    const fovy = this.cam_.frustum.fovy;\n    const metersPerUnit = this.view_.getProjection().getMetersPerUnit();\n\n    const visibleMeters = 2 * distance * Math.tan(fovy / 2);\n    const relativeCircumference = Math.cos(Math.abs(latitude));\n    const visibleMapUnits = visibleMeters / metersPerUnit / relativeCircumference;\n    const resolution = visibleMapUnits / canvas.clientHeight;\n\n    return resolution;\n  }\n}\n\n\nexport default Camera;\n","/**\n * @module olcs.AbstractSynchronizer\n */\nimport {unByKey as olObservableUnByKey} from 'ol/Observable.js';\nimport olLayerGroup from 'ol/layer/Group.js';\nimport {olcsListen, getUid} from './util.js';\n\n\nclass AbstractSynchronizer {\n  /**\n   * @param {!ol.Map} map\n   * @param {!Cesium.Scene} scene\n   * @template T\n   * @abstract\n   * @api\n   */\n  constructor(map, scene) {\n    /**\n     * @type {!ol.Map}\n     * @protected\n     */\n    this.map = map;\n\n    /**\n     * @type {ol.View}\n     * @protected\n     */\n    this.view = map.getView();\n\n    /**\n     * @type {!Cesium.Scene}\n     * @protected\n     */\n    this.scene = scene;\n\n    /**\n     * @type {ol.Collection.<ol.layer.Base>}\n     * @protected\n     */\n    this.olLayers = map.getLayerGroup().getLayers();\n\n    /**\n     * @type {ol.layer.Group}\n     */\n    this.mapLayerGroup = map.getLayerGroup();\n\n    /**\n     * Map of OpenLayers layer ids (from getUid) to the Cesium ImageryLayers.\n     * Null value means, that we are unable to create equivalent layers.\n     * @type {Object.<string, ?Array.<T>>}\n     * @protected\n     */\n    this.layerMap = {};\n\n    /**\n     * Map of listen keys for OpenLayers layer layers ids (from getUid).\n     * @type {!Object.<string, Array<ol.EventsKey>>}\n     * @protected\n     */\n    this.olLayerListenKeys = {};\n\n    /**\n     * Map of listen keys for OpenLayers layer groups ids (from getUid).\n     * @type {!Object.<string, !Array.<ol.EventsKey>>}\n     * @private\n     */\n    this.olGroupListenKeys_ = {};\n  }\n\n  /**\n   * Destroy all and perform complete synchronization of the layers.\n   * @api\n   */\n  synchronize() {\n    this.destroyAll();\n    this.addLayers_(this.mapLayerGroup);\n  }\n\n  /**\n   * Order counterparts using the same algorithm as the Openlayers renderer:\n   * z-index then original sequence order.\n   * @protected\n   */\n  orderLayers() {\n    // Ordering logics is handled in subclasses.\n  }\n\n  /**\n   * Add a layer hierarchy.\n   * @param {ol.layer.Base} root\n   * @private\n   */\n  addLayers_(root) {\n    /** @type {Array<olcsx.LayerWithParents>} */\n    const fifo = [{\n      layer: root,\n      parents: []\n    }];\n    while (fifo.length > 0) {\n      const olLayerWithParents = fifo.splice(0, 1)[0];\n      const olLayer = olLayerWithParents.layer;\n      const olLayerId = getUid(olLayer).toString();\n      this.olLayerListenKeys[olLayerId] = [];\n      console.assert(!this.layerMap[olLayerId]);\n\n      let cesiumObjects = null;\n      if (olLayer instanceof olLayerGroup) {\n        this.listenForGroupChanges_(olLayer);\n        if (olLayer !== this.mapLayerGroup) {\n          cesiumObjects = this.createSingleLayerCounterparts(olLayerWithParents);\n        }\n        if (!cesiumObjects) {\n          olLayer.getLayers().forEach((l) => {\n            if (l) {\n              const newOlLayerWithParents = {\n                layer: l,\n                parents: olLayer === this.mapLayerGroup ?\n                  [] :\n                  [olLayerWithParents.layer].concat(olLayerWithParents.parents)\n              };\n              fifo.push(newOlLayerWithParents);\n            }\n          });\n        }\n      } else {\n        cesiumObjects = this.createSingleLayerCounterparts(olLayerWithParents);\n        if (!cesiumObjects) {\n          // keep an eye on the layers that once failed to be added (might work when the layer is updated)\n          // for example when a source is set after the layer is added to the map\n          const layerId = olLayerId;\n          const layerWithParents = olLayerWithParents;\n          const onLayerChange = (e) => {\n            const cesiumObjs = this.createSingleLayerCounterparts(layerWithParents);\n            if (cesiumObjs) {\n              // unsubscribe event listener\n              layerWithParents.layer.un('change', onLayerChange);\n              this.addCesiumObjects_(cesiumObjs, layerId, layerWithParents.layer);\n              this.orderLayers();\n            }\n          };\n          this.olLayerListenKeys[olLayerId].push(olcsListen(layerWithParents.layer, 'change', onLayerChange));\n        }\n      }\n      // add Cesium layers\n      if (cesiumObjects) {\n        this.addCesiumObjects_(cesiumObjects, olLayerId, olLayer);\n      }\n    }\n\n    this.orderLayers();\n  }\n\n  /**\n   * Add Cesium objects.\n   * @param {Array.<T>} cesiumObjects\n   * @param {string} layerId\n   * @param {ol.layer.Base} layer\n   * @private\n   */\n  addCesiumObjects_(cesiumObjects, layerId, layer) {\n    this.layerMap[layerId] = cesiumObjects;\n    this.olLayerListenKeys[layerId].push(olcsListen(layer, 'change:zIndex', () => this.orderLayers()));\n    cesiumObjects.forEach((cesiumObject) => {\n      this.addCesiumObject(cesiumObject);\n    });\n  }\n\n  /**\n   * Remove and destroy a single layer.\n   * @param {ol.layer.Layer} layer\n   * @return {boolean} counterpart destroyed\n   * @private\n   */\n  removeAndDestroySingleLayer_(layer) {\n    const uid = getUid(layer).toString();\n    const counterparts = this.layerMap[uid];\n    if (!!counterparts) {\n      counterparts.forEach((counterpart) => {\n        this.removeSingleCesiumObject(counterpart, false);\n        this.destroyCesiumObject(counterpart);\n      });\n      this.olLayerListenKeys[uid].forEach(olObservableUnByKey);\n      delete this.olLayerListenKeys[uid];\n    }\n    delete this.layerMap[uid];\n    return !!counterparts;\n  }\n\n  /**\n   * Unlisten a single layer group.\n   * @param {ol.layer.Group} group\n   * @private\n   */\n  unlistenSingleGroup_(group) {\n    if (group === this.mapLayerGroup) {\n      return;\n    }\n    const uid = getUid(group).toString();\n    const keys = this.olGroupListenKeys_[uid];\n    keys.forEach((key) => {\n      olObservableUnByKey(key);\n    });\n    delete this.olGroupListenKeys_[uid];\n    delete this.layerMap[uid];\n  }\n\n  /**\n   * Remove layer hierarchy.\n   * @param {ol.layer.Base} root\n   * @private\n   */\n  removeLayer_(root) {\n    if (!!root) {\n      const fifo = [root];\n      while (fifo.length > 0) {\n        const olLayer = fifo.splice(0, 1)[0];\n        const done = this.removeAndDestroySingleLayer_(olLayer);\n        if (olLayer instanceof olLayerGroup) {\n          this.unlistenSingleGroup_(olLayer);\n          if (!done) {\n            // No counterpart for the group itself so removing\n            // each of the child layers.\n            olLayer.getLayers().forEach((l) => {\n              fifo.push(l);\n            });\n          }\n        }\n      }\n    }\n  }\n\n  /**\n   * Register listeners for single layer group change.\n   * @param {ol.layer.Group} group\n   * @private\n   */\n  listenForGroupChanges_(group) {\n    const uuid = getUid(group).toString();\n\n    console.assert(this.olGroupListenKeys_[uuid] === undefined);\n\n    const listenKeyArray = [];\n    this.olGroupListenKeys_[uuid] = listenKeyArray;\n\n    // only the keys that need to be relistened when collection changes\n    let contentKeys = [];\n    const listenAddRemove = (function() {\n      const collection = group.getLayers();\n      if (collection) {\n        contentKeys = [\n          collection.on('add', (event) => {\n            this.addLayers_(event.element);\n          }),\n          collection.on('remove', (event) => {\n            this.removeLayer_(event.element);\n          })\n        ];\n        listenKeyArray.push(...contentKeys);\n      }\n    }).bind(this);\n\n    listenAddRemove();\n\n    listenKeyArray.push(group.on('change:layers', (e) => {\n      contentKeys.forEach((el) => {\n        const i = listenKeyArray.indexOf(el);\n        if (i >= 0) {\n          listenKeyArray.splice(i, 1);\n        }\n        olObservableUnByKey(el);\n      });\n      listenAddRemove();\n    }));\n  }\n\n  /**\n   * Destroys all the created Cesium objects.\n   * @protected\n   */\n  destroyAll() {\n    this.removeAllCesiumObjects(true); // destroy\n    let objKey;\n    for (objKey in this.olGroupListenKeys_) {\n      const keys = this.olGroupListenKeys_[objKey];\n      keys.forEach(olObservableUnByKey);\n    }\n    for (objKey in this.olLayerListenKeys) {\n      this.olLayerListenKeys[objKey].forEach(olObservableUnByKey);\n    }\n    this.olGroupListenKeys_ = {};\n    this.olLayerListenKeys = {};\n    this.layerMap = {};\n  }\n\n  /**\n   * Adds a single Cesium object to the collection.\n   * @param {!T} object\n   * @abstract\n   * @protected\n   */\n  addCesiumObject(object) {}\n\n  /**\n   * @param {!T} object\n   * @abstract\n   * @protected\n   */\n  destroyCesiumObject(object) {}\n\n  /**\n   * Remove single Cesium object from the collection.\n   * @param {!T} object\n   * @param {boolean} destroy\n   * @abstract\n   * @protected\n   */\n  removeSingleCesiumObject(object, destroy) {}\n\n  /**\n   * Remove all Cesium objects from the collection.\n   * @param {boolean} destroy\n   * @abstract\n   * @protected\n   */\n  removeAllCesiumObjects(destroy) {}\n\n  /**\n   * @param {olcsx.LayerWithParents} olLayerWithParents\n   * @return {?Array.<T>}\n   * @abstract\n   * @protected\n   */\n  createSingleLayerCounterparts(olLayerWithParents) {}\n}\n\n\nexport default AbstractSynchronizer;\n","/**\n * @module olcs.RasterSynchronizer\n */\nimport olLayerGroup from 'ol/layer/Group.js';\nimport {getUid, stableSort} from './util.js';\nimport olcsAbstractSynchronizer from './AbstractSynchronizer.js';\nimport olcsCore from './core.js';\n\nclass RasterSynchronizer extends olcsAbstractSynchronizer {\n  /**\n   * This object takes care of one-directional synchronization of\n   * Openlayers raster layers to the given Cesium globe.\n   * @param {!ol.Map} map\n   * @param {!Cesium.Scene} scene\n   * @constructor\n   * @extends {olcsAbstractSynchronizer.<Cesium.ImageryLayer>}\n   * @api\n   */\n  constructor(map, scene) {\n    super(map, scene);\n\n    /**\n     * @type {!Cesium.ImageryLayerCollection}\n     * @private\n     */\n    this.cesiumLayers_ = scene.imageryLayers;\n\n    /**\n     * @type {!Cesium.ImageryLayerCollection}\n     * @private\n     */\n    this.ourLayers_ = new Cesium.ImageryLayerCollection();\n  }\n\n  /**\n   * @inheritDoc\n   */\n  addCesiumObject(object) {\n    this.cesiumLayers_.add(object);\n    this.ourLayers_.add(object);\n  }\n\n  /**\n   * @inheritDoc\n   */\n  destroyCesiumObject(object) {\n    object.destroy();\n  }\n\n  /**\n   * @inheritDoc\n   */\n  removeSingleCesiumObject(object, destroy) {\n    this.cesiumLayers_.remove(object, destroy);\n    this.ourLayers_.remove(object, false);\n  }\n\n  /**\n   * @inheritDoc\n   */\n  removeAllCesiumObjects(destroy) {\n    for (let i = 0; i < this.ourLayers_.length; ++i) {\n      this.cesiumLayers_.remove(this.ourLayers_.get(i), destroy);\n    }\n    this.ourLayers_.removeAll(false);\n  }\n\n  /**\n   * Creates an array of Cesium.ImageryLayer.\n   * May be overriden by child classes to implement custom behavior.\n   * The default implementation handles tiled imageries in EPSG:4326 or\n   * EPSG:3859.\n   * @param {!ol.layer.Base} olLayer\n   * @param {!ol.proj.Projection} viewProj Projection of the view.\n   * @return {?Array.<!Cesium.ImageryLayer>} array or null if not possible\n   * (or supported)\n   * @protected\n   */\n  convertLayerToCesiumImageries(olLayer, viewProj) {\n    const result = olcsCore.tileLayerToImageryLayer(this.map, olLayer, viewProj);\n    return result ? [result] : null;\n  }\n\n  /**\n   * @inheritDoc\n   */\n  createSingleLayerCounterparts(olLayerWithParents) {\n    const olLayer = olLayerWithParents.layer;\n    const uid = getUid(olLayer).toString();\n    const viewProj = this.view.getProjection();\n    console.assert(viewProj);\n    const cesiumObjects = this.convertLayerToCesiumImageries(olLayer, viewProj);\n    if (cesiumObjects) {\n      const listenKeyArray = [];\n      [olLayerWithParents.layer].concat(olLayerWithParents.parents).forEach((olLayerItem) => {\n        listenKeyArray.push(olLayerItem.on(['change:opacity', 'change:visible'], () => {\n          // the compiler does not seem to be able to infer this\n          console.assert(cesiumObjects);\n          for (let i = 0; i < cesiumObjects.length; ++i) {\n            olcsCore.updateCesiumLayerProperties(olLayerWithParents, cesiumObjects[i]);\n          }\n        }));\n      });\n\n      for (let i = 0; i < cesiumObjects.length; ++i) {\n        olcsCore.updateCesiumLayerProperties(olLayerWithParents, cesiumObjects[i]);\n      }\n\n      // there is no way to modify Cesium layer extent,\n      // we have to recreate when OpenLayers layer extent changes:\n      listenKeyArray.push(olLayer.on('change:extent', (e) => {\n        for (let i = 0; i < cesiumObjects.length; ++i) {\n          this.cesiumLayers_.remove(cesiumObjects[i], true); // destroy\n          this.ourLayers_.remove(cesiumObjects[i], false);\n        }\n        delete this.layerMap[getUid(olLayer)]; // invalidate the map entry\n        this.synchronize();\n      }));\n\n      listenKeyArray.push(olLayer.on('change', (e) => {\n        // when the source changes, re-add the layer to force update\n        for (let i = 0; i < cesiumObjects.length; ++i) {\n          const position = this.cesiumLayers_.indexOf(cesiumObjects[i]);\n          if (position >= 0) {\n            this.cesiumLayers_.remove(cesiumObjects[i], false);\n            this.cesiumLayers_.add(cesiumObjects[i], position);\n          }\n        }\n      }));\n\n      this.olLayerListenKeys[uid].push(...listenKeyArray);\n    }\n\n    return Array.isArray(cesiumObjects) ? cesiumObjects : null;\n  }\n\n  /**\n   * Order counterparts using the same algorithm as the Openlayers renderer:\n   * z-index then original sequence order.\n   * @override\n   * @protected\n   */\n  orderLayers() {\n    const layers = [];\n    const zIndices = {};\n    const queue = [this.mapLayerGroup];\n\n    while (queue.length > 0) {\n      const olLayer = queue.splice(0, 1)[0];\n      layers.push(olLayer);\n      zIndices[getUid(olLayer)] = olLayer.getZIndex();\n\n      if (olLayer instanceof olLayerGroup) {\n        const sublayers = olLayer.getLayers();\n        if (sublayers) {\n          // Prepend queue with sublayers in order\n          queue.unshift(...sublayers.getArray());\n        }\n      }\n    }\n\n    stableSort(layers, (layer1, layer2) =>\n      zIndices[getUid(layer1)] - zIndices[getUid(layer2)]\n    );\n\n    layers.forEach((olLayer) => {\n      const olLayerId = getUid(olLayer).toString();\n      const cesiumObjects = this.layerMap[olLayerId];\n      if (cesiumObjects) {\n        cesiumObjects.forEach((cesiumObject) => { this.raiseToTop(cesiumObject); });\n      }\n    });\n  }\n\n  /**\n   * @param {Cesium.ImageryLayer} counterpart\n   */\n  raiseToTop(counterpart) {\n    this.cesiumLayers_.raiseToTop(counterpart);\n  }\n}\n\n\nexport default RasterSynchronizer;\n","/**\n * @module olcs.core.VectorLayerCounterpart\n */\nimport {unByKey as olObservableUnByKey} from 'ol/Observable.js';\n\nclass VectorLayerCounterpart {\n  /**\n  * Result of the conversion of an OpenLayers layer to Cesium.\n  * @param {!(ol.proj.Projection|string)} layerProjection\n  * @param {!Cesium.Scene} scene\n  */\n  constructor(layerProjection, scene) {\n    const billboards = new Cesium.BillboardCollection({scene});\n    const primitives = new Cesium.PrimitiveCollection();\n\n    /**\n    * @type {!Array.<ol.EventsKey>}\n    */\n    this.olListenKeys = [];\n\n    this.rootCollection_ = new Cesium.PrimitiveCollection();\n    /**\n    * @type {!olcsx.core.OlFeatureToCesiumContext}\n    */\n    this.context = {\n      projection: layerProjection,\n      billboards,\n      featureToCesiumMap: {},\n      primitives\n    };\n\n    this.rootCollection_.add(billboards);\n    this.rootCollection_.add(primitives);\n  }\n\n  /**\n  * Unlisten.\n  */\n  destroy() {\n    this.olListenKeys.forEach(olObservableUnByKey);\n    this.olListenKeys.length = 0;\n  }\n\n  /**\n  * @return {!Cesium.Primitive}\n  */\n  getRootPrimitive() {\n    return this.rootCollection_;\n  }\n}\n\n\nexport default VectorLayerCounterpart;\n","/**\n * @module olcs.FeatureConverter\n */\nimport olGeomGeometry from 'ol/geom/Geometry.js';\nimport olStyleIcon from 'ol/style/Icon.js';\nimport olSourceVector from 'ol/source/Vector.js';\nimport olSourceCluster from 'ol/source/Cluster.js';\nimport {circular as olCreateCircularPolygon} from 'ol/geom/Polygon.js';\nimport {boundingExtent, getCenter} from 'ol/extent.js';\nimport olGeomSimpleGeometry from 'ol/geom/SimpleGeometry.js';\nimport olcsCore from './core.js';\nimport olcsCoreVectorLayerCounterpart from './core/VectorLayerCounterpart.js';\nimport olcsUtil, {getUid} from './util.js';\n\nclass FeatureConverter {\n  /**\n   * Concrete base class for converting from OpenLayers3 vectors to Cesium\n   * primitives.\n   * Extending this class is possible provided that the extending class and\n   * the library are compiled together by the closure compiler.\n   * @param {!Cesium.Scene} scene Cesium scene.\n   * @constructor\n   * @api\n   */\n  constructor(scene) {\n\n    /**\n     * @protected\n     */\n    this.scene = scene;\n\n    /**\n     * Bind once to have a unique function for using as a listener\n     * @type {function(ol.source.Vector.Event)}\n     * @private\n     */\n    this.boundOnRemoveOrClearFeatureListener_ =\n        this.onRemoveOrClearFeature_.bind(this);\n  }\n\n  /**\n   * @param {ol.source.Vector.Event} evt\n   * @private\n   */\n  onRemoveOrClearFeature_(evt) {\n    const source = evt.target;\n    console.assert(source instanceof olSourceVector);\n\n    const cancellers = olcsUtil.obj(source)['olcs_cancellers'];\n    if (cancellers) {\n      const feature = evt.feature;\n      if (feature) {\n        // remove\n        const id = getUid(feature);\n        const canceller = cancellers[id];\n        if (canceller) {\n          canceller();\n          delete cancellers[id];\n        }\n      } else {\n        // clear\n        for (const key in cancellers) {\n          if (cancellers.hasOwnProperty(key)) {\n            cancellers[key]();\n          }\n        }\n        olcsUtil.obj(source)['olcs_cancellers'] = {};\n      }\n    }\n  }\n\n  /**\n   * @param {ol.layer.Vector|ol.layer.Image} layer\n   * @param {!ol.Feature} feature OpenLayers feature.\n   * @param {!Cesium.Primitive|Cesium.Label|Cesium.Billboard} primitive\n   * @protected\n   */\n  setReferenceForPicking(layer, feature, primitive) {\n    primitive.olLayer = layer;\n    primitive.olFeature = feature;\n  }\n\n  /**\n   * Basics primitive creation using a color attribute.\n   * Note that Cesium has 'interior' and outline geometries.\n   * @param {ol.layer.Vector|ol.layer.Image} layer\n   * @param {!ol.Feature} feature OpenLayers feature.\n   * @param {!ol.geom.Geometry} olGeometry OpenLayers geometry.\n   * @param {!Cesium.Geometry} geometry\n   * @param {!Cesium.Color} color\n   * @param {number=} opt_lineWidth\n   * @return {Cesium.Primitive}\n   * @protected\n   */\n  createColoredPrimitive(layer, feature, olGeometry, geometry, color, opt_lineWidth) {\n    const createInstance = function(geometry, color) {\n      const instance = new Cesium.GeometryInstance({\n        // always update Cesium externs before adding a property\n        geometry\n      });\n      if (color && !(color instanceof Cesium.ImageMaterialProperty)) {\n        instance.attributes = {\n          color: Cesium.ColorGeometryInstanceAttribute.fromColor(color)\n        };\n      }\n      return instance;\n    };\n\n    const options = {\n      // always update Cesium externs before adding a property\n      flat: true, // work with all geometries\n      renderState: {\n        depthTest: {\n          enabled: true\n        }\n      }\n    };\n\n    if (opt_lineWidth !== undefined) {\n      if (!options.renderState) {\n        options.renderState = {};\n      }\n      options.renderState.lineWidth = opt_lineWidth;\n    }\n\n    const instances = createInstance(geometry, color);\n\n    const heightReference = this.getHeightReference(layer, feature, olGeometry);\n\n    let primitive;\n\n    if (heightReference === Cesium.HeightReference.CLAMP_TO_GROUND) {\n      const ctor = instances.geometry.constructor;\n      if (ctor && !ctor['createShadowVolume']) {\n        return null;\n      }\n      primitive = new Cesium.GroundPrimitive({\n        geometryInstances: instances\n      });\n    } else {\n      primitive = new Cesium.Primitive({\n        geometryInstances: instances\n      });\n    }\n\n    if (color instanceof Cesium.ImageMaterialProperty) {\n      const dataUri = color.image.getValue().toDataURL();\n\n      primitive.appearance = new Cesium.MaterialAppearance({\n        flat: true,\n        renderState: {\n          depthTest: {\n            enabled: true\n          }\n        },\n        material: new Cesium.Material({\n          fabric: {\n            type: 'Image',\n            uniforms: {\n              image: dataUri\n            }\n          }\n        })\n      });\n    } else {\n      primitive.appearance = new Cesium.PerInstanceColorAppearance(options);\n    }\n\n    this.setReferenceForPicking(layer, feature, primitive);\n    return primitive;\n  }\n\n  /**\n   * Return the fill or stroke color from a plain ol style.\n   * @param {!ol.style.Style|ol.style.Text} style\n   * @param {boolean} outline\n   * @return {!Cesium.Color}\n   * @protected\n   */\n  extractColorFromOlStyle(style, outline) {\n    const fillColor = style.getFill() ? style.getFill().getColor() : null;\n    const strokeColor = style.getStroke() ? style.getStroke().getColor() : null;\n\n    let olColor = 'black';\n    if (strokeColor && outline) {\n      olColor = strokeColor;\n    } else if (fillColor) {\n      olColor = fillColor;\n    }\n\n    return olcsCore.convertColorToCesium(olColor);\n  }\n\n  /**\n   * Return the width of stroke from a plain ol style.\n   * @param {!ol.style.Style|ol.style.Text} style\n   * @return {number}\n   * @protected\n   */\n  extractLineWidthFromOlStyle(style) {\n    // Handling of line width WebGL limitations is handled by Cesium.\n    const width = style.getStroke() ? style.getStroke().getWidth() : undefined;\n    return width !== undefined ? width : 1;\n  }\n\n  /**\n   * Create a primitive collection out of two Cesium geometries.\n   * Only the OpenLayers style colors will be used.\n   * @param {ol.layer.Vector|ol.layer.Image} layer\n   * @param {!ol.Feature} feature OpenLayers feature.\n   * @param {!ol.geom.Geometry} olGeometry OpenLayers geometry.\n   * @param {!Cesium.Geometry} fillGeometry\n   * @param {!Cesium.Geometry} outlineGeometry\n   * @param {!ol.style.Style} olStyle\n   * @return {!Cesium.PrimitiveCollection}\n   * @protected\n   */\n  wrapFillAndOutlineGeometries(layer, feature, olGeometry, fillGeometry, outlineGeometry, olStyle) {\n    const fillColor = this.extractColorFromOlStyle(olStyle, false);\n    const outlineColor = this.extractColorFromOlStyle(olStyle, true);\n\n    const primitives = new Cesium.PrimitiveCollection();\n    if (olStyle.getFill()) {\n      const p1 = this.createColoredPrimitive(layer, feature, olGeometry,\n          fillGeometry, fillColor);\n      console.assert(!!p1);\n      primitives.add(p1);\n    }\n\n    if (olStyle.getStroke() && outlineGeometry) {\n      const width = this.extractLineWidthFromOlStyle(olStyle);\n      const p2 = this.createColoredPrimitive(layer, feature, olGeometry,\n          outlineGeometry, outlineColor, width);\n      if (p2) {\n        // Some outline geometries are not supported by Cesium in clamp to ground\n        // mode. These primitives are skipped.\n        primitives.add(p2);\n      }\n    }\n\n    return primitives;\n  }\n\n  // Geometry converters\n  /**\n   * Create a Cesium primitive if style has a text component.\n   * Eventually return a PrimitiveCollection including current primitive.\n   * @param {ol.layer.Vector|ol.layer.Image} layer\n   * @param {!ol.Feature} feature OpenLayers feature..\n   * @param {!ol.geom.Geometry} geometry\n   * @param {!ol.style.Style} style\n   * @param {!Cesium.Primitive} primitive current primitive\n   * @return {!Cesium.PrimitiveCollection}\n   * @protected\n   */\n  addTextStyle(layer, feature, geometry, style, primitive) {\n    let primitives;\n    if (!(primitive instanceof Cesium.PrimitiveCollection)) {\n      primitives = new Cesium.PrimitiveCollection();\n      primitives.add(primitive);\n    } else {\n      primitives = primitive;\n    }\n\n    if (!style.getText()) {\n      return primitives;\n    }\n\n    const text = /** @type {!ol.style.Text} */ (style.getText());\n    const label = this.olGeometry4326TextPartToCesium(layer, feature, geometry,\n        text);\n    if (label) {\n      primitives.add(label);\n    }\n    return primitives;\n  }\n\n  /**\n   * Add a billboard to a Cesium.BillboardCollection.\n   * Overriding this wrapper allows manipulating the billboard options.\n   * @param {!Cesium.BillboardCollection} billboards\n   * @param {!Cesium.optionsBillboardCollectionAdd} bbOptions\n   * @param {ol.layer.Vector|ol.layer.Image} layer\n   * @param {!ol.Feature} feature OpenLayers feature.\n   * @param {!ol.geom.Geometry} geometry\n   * @param {!ol.style.Style} style\n   * @return {!Cesium.Billboard} newly created billboard\n   * @api\n   */\n  csAddBillboard(billboards, bbOptions, layer, feature, geometry, style) {\n    const bb = billboards.add(bbOptions);\n    this.setReferenceForPicking(layer, feature, bb);\n    return bb;\n  }\n\n  /**\n   * Convert an OpenLayers circle geometry to Cesium.\n   * @param {ol.layer.Vector|ol.layer.Image} layer\n   * @param {!ol.Feature} feature OpenLayers feature..\n   * @param {!ol.geom.Circle} olGeometry OpenLayers circle geometry.\n   * @param {!ol.ProjectionLike} projection\n   * @param {!ol.style.Style} olStyle\n   * @return {!Cesium.PrimitiveCollection} primitives\n   * @api\n   */\n  olCircleGeometryToCesium(layer, feature, olGeometry, projection, olStyle) {\n\n    olGeometry = olcsCore.olGeometryCloneTo4326(olGeometry, projection);\n    console.assert(olGeometry.getType() == 'Circle');\n\n    // ol.Coordinate\n    let center = olGeometry.getCenter();\n    const height = center.length == 3 ? center[2] : 0.0;\n    let point = center.slice();\n    point[0] += olGeometry.getRadius();\n\n    // Cesium\n    center = olcsCore.ol4326CoordinateToCesiumCartesian(center);\n    point = olcsCore.ol4326CoordinateToCesiumCartesian(point);\n\n    // Accurate computation of straight distance\n    const radius = Cesium.Cartesian3.distance(center, point);\n\n    const fillGeometry = new Cesium.CircleGeometry({\n      // always update Cesium externs before adding a property\n      center,\n      radius,\n      height\n    });\n\n    let outlinePrimitive, outlineGeometry;\n    if (this.getHeightReference(layer, feature, olGeometry) === Cesium.HeightReference.CLAMP_TO_GROUND) {\n      const width = this.extractLineWidthFromOlStyle(olStyle);\n      if (width) {\n        const circlePolygon = olCreateCircularPolygon(olGeometry.getCenter(), radius);\n        const positions = olcsCore.ol4326CoordinateArrayToCsCartesians(circlePolygon.getLinearRing(0).getCoordinates());\n        if (!Cesium.GroundPolylinePrimitive.isSupported(this.scene)) {\n          const color = this.extractColorFromOlStyle(olStyle, true);\n          outlinePrimitive = this.createStackedGroundCorridors(layer, feature, width, color, positions);\n        } else {\n          outlinePrimitive = new Cesium.GroundPolylinePrimitive({\n            geometryInstances: new Cesium.GeometryInstance({\n              geometry: new Cesium.GroundPolylineGeometry({positions, width}),\n            }),\n            appearance: new Cesium.PolylineMaterialAppearance({\n              material: this.olStyleToCesium(feature, olStyle, true),\n            }),\n            classificationType: Cesium.ClassificationType.TERRAIN,\n          });\n          outlinePrimitive.readyPromise.then(() => {\n            this.setReferenceForPicking(layer, feature, outlinePrimitive._primitive);\n          });\n        }\n      }\n    } else {\n      outlineGeometry = new Cesium.CircleOutlineGeometry({\n        // always update Cesium externs before adding a property\n        center,\n        radius,\n        extrudedHeight: height,\n        height\n      });\n    }\n\n    const primitives = this.wrapFillAndOutlineGeometries(\n        layer, feature, olGeometry, fillGeometry, outlineGeometry, olStyle);\n\n    if (outlinePrimitive) {\n      primitives.add(outlinePrimitive);\n    }\n    return this.addTextStyle(layer, feature, olGeometry, olStyle, primitives);\n  }\n\n  /**\n   * @param {ol.layer.Vector|ol.layer.Image} layer\n   * @param {!ol.Feature} feature OpenLayers feature..\n   * @param {!number} width The width of the line.\n   * @param {!Cesium.Color} color The color of the line.\n   * @param {!Array<Cesium.Cartesian3>|Array<Array<Cesium.Cartesian3>>} positions The vertices of the line(s).\n   * @return {!Cesium.GroundPrimitive} primitive\n   */\n  createStackedGroundCorridors(layer, feature, width, color, positions) {\n    // Convert positions to an Array if it isn't\n    if (!Array.isArray(positions[0])) {\n      positions = [positions];\n    }\n    width = Math.max(3, width); // A <3px width is too small for ground primitives\n    const geometryInstances = [];\n    let previousDistance = 0;\n    // A stack of ground lines with increasing width (in meters) are created.\n    // Only one of these lines is displayed at any time giving a feeling of continuity.\n    // The values for the distance and width factor are more or less arbitrary.\n    // Applications can override this logics by subclassing the FeatureConverter class.\n    for (const distance of [1000, 4000, 16000, 64000, 254000, 1000000, 10000000]) {\n      width *= 2.14;\n      const geometryOptions = {\n        // always update Cesium externs before adding a property\n        width,\n        vertexFormat: Cesium.VertexFormat.POSITION_ONLY\n      };\n      for (const linePositions of positions) {\n        geometryOptions.positions = linePositions;\n        geometryInstances.push(new Cesium.GeometryInstance({\n          geometry: new Cesium.CorridorGeometry(geometryOptions),\n          attributes: {\n            color: Cesium.ColorGeometryInstanceAttribute.fromColor(color),\n            distanceDisplayCondition: new Cesium.DistanceDisplayConditionGeometryInstanceAttribute(previousDistance, distance - 1)\n          }\n        }));\n      }\n      previousDistance = distance;\n    }\n    return new Cesium.GroundPrimitive({\n      // always update Cesium externs before adding a property\n      geometryInstances\n    });\n  }\n\n  /**\n   * Convert an OpenLayers line string geometry to Cesium.\n   * @param {ol.layer.Vector|ol.layer.Image} layer\n   * @param {!ol.Feature} feature OpenLayers feature..\n   * @param {!ol.geom.LineString} olGeometry OpenLayers line string geometry.\n   * @param {!ol.ProjectionLike} projection\n   * @param {!ol.style.Style} olStyle\n   * @return {!Cesium.PrimitiveCollection} primitives\n   * @api\n   */\n  olLineStringGeometryToCesium(layer, feature, olGeometry, projection, olStyle) {\n\n    olGeometry = olcsCore.olGeometryCloneTo4326(olGeometry, projection);\n    console.assert(olGeometry.getType() == 'LineString');\n\n    const positions = olcsCore.ol4326CoordinateArrayToCsCartesians(olGeometry.getCoordinates());\n    const width = this.extractLineWidthFromOlStyle(olStyle);\n\n    let outlinePrimitive;\n    const heightReference = this.getHeightReference(layer, feature, olGeometry);\n\n    if (heightReference === Cesium.HeightReference.CLAMP_TO_GROUND && !Cesium.GroundPolylinePrimitive.isSupported(this.scene)) {\n      const color = this.extractColorFromOlStyle(olStyle, true);\n      outlinePrimitive = this.createStackedGroundCorridors(layer, feature, width, color, positions);\n    } else {\n      const appearance = new Cesium.PolylineMaterialAppearance({\n        // always update Cesium externs before adding a property\n        material: this.olStyleToCesium(feature, olStyle, true)\n      });\n      const geometryOptions = {\n        // always update Cesium externs before adding a property\n        positions,\n        width,\n      };\n      const primitiveOptions = {\n        // always update Cesium externs before adding a property\n        appearance\n      };\n      if (heightReference === Cesium.HeightReference.CLAMP_TO_GROUND) {\n        const geometry = new Cesium.GroundPolylineGeometry(geometryOptions);\n        primitiveOptions.geometryInstances = new Cesium.GeometryInstance({\n          geometry\n        }),\n        outlinePrimitive = new Cesium.GroundPolylinePrimitive(primitiveOptions);\n        outlinePrimitive.readyPromise.then(() => {\n          this.setReferenceForPicking(layer, feature, outlinePrimitive._primitive);\n        });\n      } else {\n        geometryOptions.vertexFormat = appearance.vertexFormat;\n        const geometry = new Cesium.PolylineGeometry(geometryOptions);\n        primitiveOptions.geometryInstances = new Cesium.GeometryInstance({\n          geometry\n        }),\n        outlinePrimitive = new Cesium.Primitive(primitiveOptions);\n      }\n    }\n\n    this.setReferenceForPicking(layer, feature, outlinePrimitive);\n\n    return this.addTextStyle(layer, feature, olGeometry, olStyle, outlinePrimitive);\n  }\n\n  /**\n   * Convert an OpenLayers polygon geometry to Cesium.\n   * @param {ol.layer.Vector|ol.layer.Image} layer\n   * @param {!ol.Feature} feature OpenLayers feature..\n   * @param {!ol.geom.Polygon} olGeometry OpenLayers polygon geometry.\n   * @param {!ol.ProjectionLike} projection\n   * @param {!ol.style.Style} olStyle\n   * @return {!Cesium.PrimitiveCollection} primitives\n   * @api\n   */\n  olPolygonGeometryToCesium(layer, feature, olGeometry, projection, olStyle) {\n\n    olGeometry = olcsCore.olGeometryCloneTo4326(olGeometry, projection);\n    console.assert(olGeometry.getType() == 'Polygon');\n\n    const heightReference = this.getHeightReference(layer, feature, olGeometry);\n\n    let fillGeometry, outlineGeometry, outlinePrimitive;\n    if ((olGeometry.getCoordinates()[0].length == 5) &&\n        (feature.getGeometry().get('olcs.polygon_kind') === 'rectangle')) {\n      // Create a rectangle according to the longitude and latitude curves\n      const coordinates = olGeometry.getCoordinates()[0];\n      // Extract the West, South, East, North coordinates\n      const extent = boundingExtent(coordinates);\n      const rectangle = Cesium.Rectangle.fromDegrees(extent[0], extent[1],\n          extent[2], extent[3]);\n\n      // Extract the average height of the vertices\n      let maxHeight = 0.0;\n      if (coordinates[0].length == 3) {\n        for (let c = 0; c < coordinates.length; c++) {\n          maxHeight = Math.max(maxHeight, coordinates[c][2]);\n        }\n      }\n\n      // Render the cartographic rectangle\n      fillGeometry = new Cesium.RectangleGeometry({\n        ellipsoid: Cesium.Ellipsoid.WGS84,\n        rectangle,\n        height: maxHeight\n      });\n\n      outlineGeometry = new Cesium.RectangleOutlineGeometry({\n        ellipsoid: Cesium.Ellipsoid.WGS84,\n        rectangle,\n        height: maxHeight\n      });\n    } else {\n      const rings = olGeometry.getLinearRings();\n      // always update Cesium externs before adding a property\n      const hierarchy = {};\n      const polygonHierarchy = hierarchy;\n      console.assert(rings.length > 0);\n\n      for (let i = 0; i < rings.length; ++i) {\n        const olPos = rings[i].getCoordinates();\n        const positions = olcsCore.ol4326CoordinateArrayToCsCartesians(olPos);\n        console.assert(positions && positions.length > 0);\n        if (i == 0) {\n          hierarchy.positions = positions;\n        } else {\n          if (!hierarchy.holes) {\n            hierarchy.holes = [];\n          }\n          hierarchy.holes.push({\n            positions\n          });\n        }\n      }\n\n      fillGeometry = new Cesium.PolygonGeometry({\n        // always update Cesium externs before adding a property\n        polygonHierarchy,\n        perPositionHeight: true\n      });\n\n      // Since Cesium doesn't yet support Polygon outlines on terrain yet (coming soon...?)\n      // we don't create an outline geometry if clamped, but instead do the polyline method\n      // for each ring. Most of this code should be removeable when Cesium adds\n      // support for Polygon outlines on terrain.\n      if (heightReference === Cesium.HeightReference.CLAMP_TO_GROUND) {\n        const width = this.extractLineWidthFromOlStyle(olStyle);\n        if (width > 0) {\n          const positions = [hierarchy.positions];\n          if (hierarchy.holes) {\n            for (let i = 0; i < hierarchy.holes.length; ++i) {\n              positions.push(hierarchy.holes[i].positions);\n            }\n          }\n          if (!Cesium.GroundPolylinePrimitive.isSupported(this.scene)) {\n            const color = this.extractColorFromOlStyle(olStyle, true);\n            outlinePrimitive = this.createStackedGroundCorridors(layer, feature, width, color, positions);\n          } else {\n            const appearance = new Cesium.PolylineMaterialAppearance({\n              // always update Cesium externs before adding a property\n              material: this.olStyleToCesium(feature, olStyle, true)\n            });\n            const geometryInstances = [];\n            for (const linePositions of positions) {\n              const polylineGeometry = new Cesium.GroundPolylineGeometry({positions: linePositions, width});\n              geometryInstances.push(new Cesium.GeometryInstance({\n                geometry: polylineGeometry\n              }));\n            }\n            const primitiveOptions = {\n              // always update Cesium externs before adding a property\n              appearance,\n              geometryInstances\n            };\n            outlinePrimitive = new Cesium.GroundPolylinePrimitive(primitiveOptions);\n            outlinePrimitive.readyPromise.then(() => {\n              this.setReferenceForPicking(layer, feature, outlinePrimitive._primitive);\n            });\n          }\n        }\n      } else {\n        // Actually do the normal polygon thing. This should end the removable\n        // section of code described above.\n        outlineGeometry = new Cesium.PolygonOutlineGeometry({\n          // always update Cesium externs before adding a property\n          polygonHierarchy: hierarchy,\n          perPositionHeight: true\n        });\n      }\n    }\n\n    const primitives = this.wrapFillAndOutlineGeometries(\n        layer, feature, olGeometry, fillGeometry, outlineGeometry, olStyle);\n\n    if (outlinePrimitive) {\n      primitives.add(outlinePrimitive);\n    }\n\n    return this.addTextStyle(layer, feature, olGeometry, olStyle, primitives);\n  }\n\n  /**\n   * @param {ol.layer.Vector|ol.layer.Image} layer\n   * @param {ol.Feature} feature OpenLayers feature..\n   * @param {!ol.geom.Geometry} geometry\n   * @return {!Cesium.HeightReference}\n   * @api\n   */\n  getHeightReference(layer, feature, geometry) {\n\n    // Read from the geometry\n    let altitudeMode = geometry.get('altitudeMode');\n\n    // Or from the feature\n    if (altitudeMode === undefined) {\n      altitudeMode = feature.get('altitudeMode');\n    }\n\n    // Or from the layer\n    if (altitudeMode === undefined) {\n      altitudeMode = layer.get('altitudeMode');\n    }\n\n    let heightReference = Cesium.HeightReference.NONE;\n    if (altitudeMode === 'clampToGround') {\n      heightReference = Cesium.HeightReference.CLAMP_TO_GROUND;\n    } else if (altitudeMode === 'relativeToGround') {\n      heightReference = Cesium.HeightReference.RELATIVE_TO_GROUND;\n    }\n\n    return heightReference;\n  }\n\n  /**\n   * Convert a point geometry to a Cesium BillboardCollection.\n   * @param {ol.layer.Vector|ol.layer.Image} layer\n   * @param {!ol.Feature} feature OpenLayers feature..\n   * @param {!ol.geom.Point} olGeometry OpenLayers point geometry.\n   * @param {!ol.ProjectionLike} projection\n   * @param {!ol.style.Style} style\n   * @param {!ol.style.Image} imageStyle\n   * @param {!Cesium.BillboardCollection} billboards\n   * @param {function(!Cesium.Billboard)=} opt_newBillboardCallback Called when the new billboard is added.\n   * @api\n   */\n  createBillboardFromImage(\n      layer,\n      feature,\n      olGeometry,\n      projection,\n      style,\n      imageStyle,\n      billboards,\n      opt_newBillboardCallback\n  ) {\n\n    if (imageStyle instanceof olStyleIcon) {\n      // make sure the image is scheduled for load\n      imageStyle.load();\n    }\n\n    const image = imageStyle.getImage(1); // get normal density\n    const isImageLoaded = function(image) {\n      return image.src != '' &&\n          image.naturalHeight != 0 &&\n          image.naturalWidth != 0 &&\n          image.complete;\n    };\n    const reallyCreateBillboard = (function() {\n      if (!image) {\n        return;\n      }\n      if (!(image instanceof HTMLCanvasElement ||\n          image instanceof Image ||\n          image instanceof HTMLImageElement)) {\n        return;\n      }\n      const center = olGeometry.getCoordinates();\n      const position = olcsCore.ol4326CoordinateToCesiumCartesian(center);\n      let color;\n      const opacity = imageStyle.getOpacity();\n      if (opacity !== undefined) {\n        color = new Cesium.Color(1.0, 1.0, 1.0, opacity);\n      }\n\n      const heightReference = this.getHeightReference(layer, feature, olGeometry);\n\n      const bbOptions = /** @type {Cesium.optionsBillboardCollectionAdd} */ ({\n        // always update Cesium externs before adding a property\n        image,\n        color,\n        scale: imageStyle.getScale(),\n        heightReference,\n        verticalOrigin: Cesium.VerticalOrigin.BOTTOM,\n        position\n      });\n      const bb = this.csAddBillboard(billboards, bbOptions, layer, feature, olGeometry, style);\n      if (opt_newBillboardCallback) {\n        opt_newBillboardCallback(bb);\n      }\n    }).bind(this);\n\n    if (image instanceof Image && !isImageLoaded(image)) {\n      // Cesium requires the image to be loaded\n      let cancelled = false;\n      const source = layer.getSource();\n      const canceller = function() {\n        cancelled = true;\n      };\n      source.on(['removefeature', 'clear'],\n          this.boundOnRemoveOrClearFeatureListener_);\n      let cancellers = olcsUtil.obj(source)['olcs_cancellers'];\n      if (!cancellers) {\n        cancellers = olcsUtil.obj(source)['olcs_cancellers'] = {};\n      }\n\n      const fuid = getUid(feature);\n      if (cancellers[fuid]) {\n        // When the feature change quickly, a canceller may still be present so\n        // we cancel it here to prevent creation of a billboard.\n        cancellers[fuid]();\n      }\n      cancellers[fuid] = canceller;\n\n      const listener = function() {\n        image.removeEventListener('load', listener);\n        if (!billboards.isDestroyed() && !cancelled) {\n          // Create billboard if the feature is still displayed on the map.\n          reallyCreateBillboard();\n        }\n      };\n\n      image.addEventListener('load', listener);\n    } else {\n      reallyCreateBillboard();\n    }\n  }\n\n  /**\n   * Convert a point geometry to a Cesium BillboardCollection.\n   * @param {ol.layer.Vector|ol.layer.Image} layer\n   * @param {!ol.Feature} feature OpenLayers feature..\n   * @param {!ol.geom.Point} olGeometry OpenLayers point geometry.\n   * @param {!ol.ProjectionLike} projection\n   * @param {!ol.style.Style} style\n   * @param {!Cesium.BillboardCollection} billboards\n   * @param {function(!Cesium.Billboard)=} opt_newBillboardCallback Called when\n   * the new billboard is added.\n   * @return {Cesium.Primitive} primitives\n   * @api\n   */\n  olPointGeometryToCesium(\n      layer,\n      feature,\n      olGeometry,\n      projection,\n      style,\n      billboards,\n      opt_newBillboardCallback\n  ) {\n    console.assert(olGeometry.getType() == 'Point');\n    olGeometry = olcsCore.olGeometryCloneTo4326(olGeometry, projection);\n\n    let modelPrimitive = null;\n    const imageStyle = style.getImage();\n    if (imageStyle) {\n      const olcsModelFunction = /** @type {function():olcsx.ModelStyle} */ (olGeometry.get('olcs_model') || feature.get('olcs_model'));\n      if (olcsModelFunction) {\n        const olcsModel = olcsModelFunction();\n        const options = /** @type {Cesium.ModelFromGltfOptions} */ (Object.assign({}, {scene: this.scene}, olcsModel.cesiumOptions));\n        const model = Cesium.Model.fromGltf(options);\n        modelPrimitive = new Cesium.PrimitiveCollection();\n        modelPrimitive.add(model);\n        if (olcsModel.debugModelMatrix) {\n          modelPrimitive.add(new Cesium.DebugModelMatrixPrimitive({\n            modelMatrix: olcsModel.debugModelMatrix\n          }));\n        }\n      } else {\n        this.createBillboardFromImage(layer, feature, olGeometry, projection, style, imageStyle, billboards, opt_newBillboardCallback);\n      }\n    }\n\n    if (style.getText()) {\n      return this.addTextStyle(layer, feature, olGeometry, style, modelPrimitive || new Cesium.Primitive());\n    } else {\n      return modelPrimitive;\n    }\n  }\n\n  /**\n   * Convert an OpenLayers multi-something geometry to Cesium.\n   * @param {ol.layer.Vector|ol.layer.Image} layer\n   * @param {!ol.Feature} feature OpenLayers feature..\n   * @param {!ol.geom.Geometry} geometry OpenLayers geometry.\n   * @param {!ol.ProjectionLike} projection\n   * @param {!ol.style.Style} olStyle\n   * @param {!Cesium.BillboardCollection} billboards\n   * @param {function(!Cesium.Billboard)=} opt_newBillboardCallback Called when\n   * the new billboard is added.\n   * @return {Cesium.Primitive} primitives\n   * @api\n   */\n  olMultiGeometryToCesium(\n      layer,\n      feature,\n      geometry,\n      projection,\n      olStyle,\n      billboards,\n      opt_newBillboardCallback\n  ) {\n    // Do not reproject to 4326 now because it will be done later.\n\n    // FIXME: would be better to combine all child geometries in one primitive\n    // instead we create n primitives for simplicity.\n    const accumulate = function(geometries, functor) {\n      const primitives = new Cesium.PrimitiveCollection();\n      geometries.forEach((geometry) => {\n        primitives.add(functor(layer, feature, geometry, projection, olStyle));\n      });\n      return primitives;\n    };\n\n    let subgeos;\n    switch (geometry.getType()) {\n      case 'MultiPoint':\n        geometry = /** @type {!ol.geom.MultiPoint} */ (geometry);\n        subgeos = geometry.getPoints();\n        if (olStyle.getText()) {\n          const primitives = new Cesium.PrimitiveCollection();\n          subgeos.forEach((geometry) => {\n            console.assert(geometry);\n            const result = this.olPointGeometryToCesium(layer, feature, geometry,\n                projection, olStyle, billboards, opt_newBillboardCallback);\n            if (result) {\n              primitives.add(result);\n            }\n          });\n          return primitives;\n        } else {\n          subgeos.forEach((geometry) => {\n            console.assert(geometry);\n            this.olPointGeometryToCesium(layer, feature, geometry, projection,\n                olStyle, billboards, opt_newBillboardCallback);\n          });\n          return null;\n        }\n      case 'MultiLineString':\n        geometry = /** @type {!ol.geom.MultiLineString} */ (geometry);\n        subgeos = geometry.getLineStrings();\n        return accumulate(subgeos, this.olLineStringGeometryToCesium.bind(this));\n      case 'MultiPolygon':\n        geometry = /** @type {!ol.geom.MultiPolygon} */ (geometry);\n        subgeos = geometry.getPolygons();\n        return accumulate(subgeos, this.olPolygonGeometryToCesium.bind(this));\n      default:\n        console.assert(false, `Unhandled multi geometry type${geometry.getType()}`);\n    }\n  }\n\n  /**\n   * Convert an OpenLayers text style to Cesium.\n   * @param {ol.layer.Vector|ol.layer.Image} layer\n   * @param {!ol.Feature} feature OpenLayers feature..\n   * @param {!ol.geom.Geometry} geometry\n   * @param {!ol.style.Text} style\n   * @return {Cesium.LabelCollection} Cesium primitive\n   * @api\n   */\n  olGeometry4326TextPartToCesium(layer, feature, geometry, style) {\n    const text = style.getText();\n    if (!text) {\n      return null;\n    }\n\n    const labels = new Cesium.LabelCollection({scene: this.scene});\n    // TODO: export and use the text draw position from OpenLayers .\n    // See src/ol/render/vector.js\n    const extentCenter = getCenter(geometry.getExtent());\n    if (geometry instanceof olGeomSimpleGeometry) {\n      const first = geometry.getFirstCoordinate();\n      extentCenter[2] = first.length == 3 ? first[2] : 0.0;\n    }\n    const options = /** @type {Cesium.optionsLabelCollection} */ ({});\n\n    options.position = olcsCore.ol4326CoordinateToCesiumCartesian(extentCenter);\n\n    options.text = text;\n\n    options.heightReference = this.getHeightReference(layer, feature, geometry);\n\n    const offsetX = style.getOffsetX();\n    const offsetY = style.getOffsetY();\n    if (offsetX != 0 && offsetY != 0) {\n      const offset = new Cesium.Cartesian2(offsetX, offsetY);\n      options.pixelOffset = offset;\n    }\n\n    options.font = style.getFont() || '10px sans-serif'; // OpenLayers default\n\n    let labelStyle = undefined;\n    if (style.getFill()) {\n      options.fillColor = this.extractColorFromOlStyle(style, false);\n      labelStyle = Cesium.LabelStyle.FILL;\n    }\n    if (style.getStroke()) {\n      options.outlineWidth = this.extractLineWidthFromOlStyle(style);\n      options.outlineColor = this.extractColorFromOlStyle(style, true);\n      labelStyle = Cesium.LabelStyle.OUTLINE;\n    }\n    if (style.getFill() && style.getStroke()) {\n      labelStyle = Cesium.LabelStyle.FILL_AND_OUTLINE;\n    }\n    options.style = labelStyle;\n\n    let horizontalOrigin;\n    switch (style.getTextAlign()) {\n      case 'left':\n        horizontalOrigin = Cesium.HorizontalOrigin.LEFT;\n        break;\n      case 'right':\n        horizontalOrigin = Cesium.HorizontalOrigin.RIGHT;\n        break;\n      case 'center':\n      default:\n        horizontalOrigin = Cesium.HorizontalOrigin.CENTER;\n    }\n    options.horizontalOrigin = horizontalOrigin;\n\n    if (style.getTextBaseline()) {\n      let verticalOrigin;\n      switch (style.getTextBaseline()) {\n        case 'top':\n          verticalOrigin = Cesium.VerticalOrigin.TOP;\n          break;\n        case 'middle':\n          verticalOrigin = Cesium.VerticalOrigin.CENTER;\n          break;\n        case 'bottom':\n          verticalOrigin = Cesium.VerticalOrigin.BOTTOM;\n          break;\n        case 'alphabetic':\n          verticalOrigin = Cesium.VerticalOrigin.TOP;\n          break;\n        case 'hanging':\n          verticalOrigin = Cesium.VerticalOrigin.BOTTOM;\n          break;\n        default:\n          console.assert(false, `unhandled baseline ${style.getTextBaseline()}`);\n      }\n      options.verticalOrigin = verticalOrigin;\n    }\n\n\n    const l = labels.add(options);\n    this.setReferenceForPicking(layer, feature, l);\n    return labels;\n  }\n\n  /**\n   * Convert an OpenLayers style to a Cesium Material.\n   * @param {ol.Feature} feature OpenLayers feature..\n   * @param {!ol.style.Style} style\n   * @param {boolean} outline\n   * @return {Cesium.Material}\n   * @api\n   */\n  olStyleToCesium(feature, style, outline) {\n    const fill = style.getFill();\n    const stroke = style.getStroke();\n    if ((outline && !stroke) || (!outline && !fill)) {\n      return null; // FIXME use a default style? Developer error?\n    }\n\n    let color = outline ? stroke.getColor() : fill.getColor();\n    color = olcsCore.convertColorToCesium(color);\n\n    if (outline && stroke.getLineDash()) {\n      return Cesium.Material.fromType('Stripe', {\n        // always update Cesium externs before adding a property\n        horizontal: false,\n        repeat: 500, // TODO how to calculate this?\n        evenColor: color,\n        oddColor: new Cesium.Color(0, 0, 0, 0) // transparent\n      });\n    } else {\n      return Cesium.Material.fromType('Color', {\n        // always update Cesium externs before adding a property\n        color\n      });\n    }\n\n  }\n\n  /**\n   * Compute OpenLayers plain style.\n   * Evaluates style function, blend arrays, get default style.\n   * @param {ol.layer.Vector|ol.layer.Image} layer\n   * @param {!ol.Feature} feature\n   * @param {ol.StyleFunction|undefined} fallbackStyleFunction\n   * @param {number} resolution\n   * @return {Array.<!ol.style.Style>} null if no style is available\n   * @api\n   */\n  computePlainStyle(layer, feature, fallbackStyleFunction, resolution) {\n    /**\n     * @type {ol.FeatureStyleFunction|undefined}\n     */\n    const featureStyleFunction = feature.getStyleFunction();\n\n    /**\n     * @type {ol.style.Style|Array.<ol.style.Style>}\n     */\n    let style = null;\n\n    if (featureStyleFunction) {\n      style = featureStyleFunction(feature, resolution);\n    }\n\n    if (!style && fallbackStyleFunction) {\n      style = fallbackStyleFunction(feature, resolution);\n    }\n\n    if (!style) {\n      // The feature must not be displayed\n      return null;\n    }\n\n    // FIXME combine materials as in cesium-materials-pack?\n    // then this function must return a custom material\n    // More simply, could blend the colors like described in\n    // http://en.wikipedia.org/wiki/Alpha_compositing\n    return Array.isArray(style) ? style : [style];\n  }\n\n  /**\n   * @protected\n   * @param {!ol.Feature} feature\n   * @param {!ol.style.Style} style\n   * @param {!ol.geom.Geometry=} opt_geom Geometry to be converted.\n   * @return {ol.geom.Geometry|undefined}\n   */\n  getGeometryFromFeature(feature, style, opt_geom) {\n    if (opt_geom) {\n      return opt_geom;\n    }\n\n    const geom3d = /** @type {!ol.geom.Geometry} */(feature.get('olcs.3d_geometry'));\n    if (geom3d && geom3d instanceof olGeomGeometry) {\n      return geom3d;\n    }\n\n    if (style) {\n      const geomFuncRes = style.getGeometryFunction()(feature);\n      if (geomFuncRes instanceof olGeomGeometry) {\n        return geomFuncRes;\n      }\n    }\n\n    return feature.getGeometry();\n  }\n\n  /**\n   * Convert one OpenLayers feature up to a collection of Cesium primitives.\n   * @param {ol.layer.Vector|ol.layer.Image} layer\n   * @param {!ol.Feature} feature OpenLayers feature.\n   * @param {!ol.style.Style} style\n   * @param {!olcsx.core.OlFeatureToCesiumContext} context\n   * @param {!ol.geom.Geometry=} opt_geom Geometry to be converted.\n   * @return {Cesium.Primitive} primitives\n   * @api\n   */\n  olFeatureToCesium(layer, feature, style, context, opt_geom) {\n    let geom = this.getGeometryFromFeature(feature, style, opt_geom);\n\n    if (!geom) {\n      // OpenLayers features may not have a geometry\n      // See http://geojson.org/geojson-spec.html#feature-objects\n      return null;\n    }\n\n    const proj = context.projection;\n    const newBillboardAddedCallback = function(bb) {\n      const featureBb = context.featureToCesiumMap[getUid(feature)];\n      if (featureBb instanceof Array) {\n        featureBb.push(bb);\n      }\n      else {\n        context.featureToCesiumMap[getUid(feature)] = [bb];\n      }\n    };\n\n    switch (geom.getType()) {\n      case 'GeometryCollection':\n        const primitives = new Cesium.PrimitiveCollection();\n        const collection = /** @type {!ol.geom.GeometryCollection} */ (geom);\n        // TODO: use getGeometriesArray() instead\n        collection.getGeometries().forEach((geom) => {\n          if (geom) {\n            const prims = this.olFeatureToCesium(layer, feature, style, context,\n                geom);\n            if (prims) {\n              primitives.add(prims);\n            }\n          }\n        });\n        return primitives;\n      case 'Point':\n        geom = /** @type {!ol.geom.Point} */ (geom);\n        const bbs = context.billboards;\n        const result = this.olPointGeometryToCesium(layer, feature, geom, proj,\n            style, bbs, newBillboardAddedCallback);\n        if (!result) {\n          // no wrapping primitive\n          return null;\n        } else {\n          return result;\n        }\n      case 'Circle':\n        geom = /** @type {!ol.geom.Circle} */ (geom);\n        return this.olCircleGeometryToCesium(layer, feature, geom, proj,\n            style);\n      case 'LineString':\n        geom = /** @type {!ol.geom.LineString} */ (geom);\n        return this.olLineStringGeometryToCesium(layer, feature, geom, proj,\n            style);\n      case 'Polygon':\n        geom = /** @type {!ol.geom.Polygon} */ (geom);\n        return this.olPolygonGeometryToCesium(layer, feature, geom, proj,\n            style);\n      case 'MultiPoint':\n      case 'MultiLineString':\n      case 'MultiPolygon':\n        const result2 = this.olMultiGeometryToCesium(layer, feature, geom, proj,\n            style, context.billboards, newBillboardAddedCallback);\n        if (!result2) {\n          // no wrapping primitive\n          return null;\n        } else {\n          return result2;\n        }\n      case 'LinearRing':\n        throw new Error('LinearRing should only be part of polygon.');\n      default:\n        throw new Error(`Ol geom type not handled : ${geom.getType()}`);\n    }\n  }\n\n  /**\n   * Convert an OpenLayers vector layer to Cesium primitive collection.\n   * For each feature, the associated primitive will be stored in\n   * `featurePrimitiveMap`.\n   * @param {!(ol.layer.Vector|ol.layer.Image)} olLayer\n   * @param {!ol.View} olView\n   * @param {!Object.<number, !Cesium.Primitive>} featurePrimitiveMap\n   * @return {!olcs.core.VectorLayerCounterpart}\n   * @api\n   */\n  olVectorLayerToCesium(olLayer, olView, featurePrimitiveMap) {\n    const proj = olView.getProjection();\n    const resolution = olView.getResolution();\n\n    if (resolution === undefined || !proj) {\n      console.assert(false, 'View not ready');\n      // an assertion is not enough for closure to assume resolution and proj\n      // are defined\n      throw new Error('View not ready');\n    }\n\n    let source = olLayer.getSource();\n    if (source instanceof olSourceCluster) {\n      source = source.getSource();\n    }\n\n    console.assert(source instanceof olSourceVector);\n    const features = source.getFeatures();\n    const counterpart = new olcsCoreVectorLayerCounterpart(proj, this.scene);\n    const context = counterpart.context;\n    for (let i = 0; i < features.length; ++i) {\n      const feature = features[i];\n      if (!feature) {\n        continue;\n      }\n      /**\n       * @type {ol.StyleFunction|undefined}\n       */\n      const layerStyle = olLayer.getStyleFunction();\n      const styles = this.computePlainStyle(olLayer, feature, layerStyle,\n          resolution);\n      if (!styles || !styles.length) {\n        // only 'render' features with a style\n        continue;\n      }\n\n      /**\n       * @type {Cesium.Primitive|null}\n       */\n      let primitives = null;\n      for (let i = 0; i < styles.length; i++) {\n        const prims = this.olFeatureToCesium(olLayer, feature, styles[i], context);\n        if (prims) {\n          if (!primitives) {\n            primitives = prims;\n          } else if (prims) {\n            let i = 0, prim;\n            while ((prim = prims.get(i))) {\n              primitives.add(prim);\n              i++;\n            }\n          }\n        }\n      }\n      if (!primitives) {\n        continue;\n      }\n      featurePrimitiveMap[getUid(feature)] = primitives;\n      counterpart.getRootPrimitive().add(primitives);\n    }\n\n    return counterpart;\n  }\n\n  /**\n   * Convert an OpenLayers feature to Cesium primitive collection.\n   * @param {!(ol.layer.Vector|ol.layer.Image)} layer\n   * @param {!ol.View} view\n   * @param {!ol.Feature} feature\n   * @param {!olcsx.core.OlFeatureToCesiumContext} context\n   * @return {Cesium.Primitive}\n   * @api\n   */\n  convert(layer, view, feature, context) {\n    const proj = view.getProjection();\n    const resolution = view.getResolution();\n\n    if (resolution == undefined || !proj) {\n      return null;\n    }\n\n    /**\n     * @type {ol.StyleFunction|undefined}\n     */\n    const layerStyle = layer.getStyleFunction();\n\n    const styles = this.computePlainStyle(layer, feature, layerStyle, resolution);\n\n    if (!styles.length) {\n      // only 'render' features with a style\n      return null;\n    }\n\n    context.projection = proj;\n\n    /**\n     * @type {Cesium.Primitive|null}\n     */\n    let primitives = null;\n    for (let i = 0; i < styles.length; i++) {\n      const prims = this.olFeatureToCesium(layer, feature, styles[i], context);\n      if (!primitives) {\n        primitives = prims;\n      } else if (prims) {\n        let i = 0, prim;\n        while ((prim = prims.get(i))) {\n          primitives.add(prim);\n          i++;\n        }\n      }\n    }\n    return primitives;\n  }\n}\n\n\nexport default FeatureConverter;\n","/**\n * @module olcs.VectorSynchronizer\n */\nimport olSourceVector from 'ol/source/Vector.js';\nimport olLayerLayer from 'ol/layer/Layer.js';\nimport olSourceCluster from 'ol/source/Cluster.js';\nimport olLayerImage from 'ol/layer/Image.js';\nimport {olcsListen, getUid} from './util.js';\nimport olLayerVector from 'ol/layer/Vector.js';\nimport olcsAbstractSynchronizer from './AbstractSynchronizer.js';\nimport olcsFeatureConverter from './FeatureConverter.js';\n\nclass VectorSynchronizer extends olcsAbstractSynchronizer {\n  /**\n   * Unidirectionally synchronize OpenLayers vector layers to Cesium.\n   * @param {!ol.Map} map\n   * @param {!Cesium.Scene} scene\n   * @param {olcs.FeatureConverter=} opt_converter\n   * @extends {olcs.AbstractSynchronizer.<olcs.core.VectorLayerCounterpart>}\n   * @api\n   */\n  constructor(map, scene, opt_converter) {\n    super(map, scene);\n\n    /**\n     * @protected\n     */\n    this.converter = opt_converter || new olcsFeatureConverter(scene);\n\n    /**\n     * @private\n     */\n    this.csAllPrimitives_ = new Cesium.PrimitiveCollection();\n    scene.primitives.add(this.csAllPrimitives_);\n    this.csAllPrimitives_.destroyPrimitives = false;\n  }\n\n  /**\n   * @inheritDoc\n   */\n  addCesiumObject(counterpart) {\n    console.assert(counterpart);\n    counterpart.getRootPrimitive()['counterpart'] = counterpart;\n    this.csAllPrimitives_.add(counterpart.getRootPrimitive());\n  }\n\n  /**\n   * @inheritDoc\n   */\n  destroyCesiumObject(object) {\n    object.getRootPrimitive().destroy();\n  }\n\n  /**\n   * @inheritDoc\n   */\n  removeSingleCesiumObject(object, destroy) {\n    object.destroy();\n    this.csAllPrimitives_.destroyPrimitives = destroy;\n    this.csAllPrimitives_.remove(object.getRootPrimitive());\n    this.csAllPrimitives_.destroyPrimitives = false;\n  }\n\n  /**\n   * @inheritDoc\n   */\n  removeAllCesiumObjects(destroy) {\n    this.csAllPrimitives_.destroyPrimitives = destroy;\n    if (destroy) {\n      for (let i = 0; i < this.csAllPrimitives_.length; ++i) {\n        this.csAllPrimitives_.get(i)['counterpart'].destroy();\n      }\n    }\n    this.csAllPrimitives_.removeAll();\n    this.csAllPrimitives_.destroyPrimitives = false;\n  }\n\n  /**\n   * Synchronizes the layer visibility properties\n   * to the given Cesium Primitive.\n   * @param {olcsx.LayerWithParents} olLayerWithParents\n   * @param {!Cesium.Primitive} csPrimitive\n   */\n  updateLayerVisibility(olLayerWithParents, csPrimitive) {\n    let visible = true;\n    [olLayerWithParents.layer].concat(olLayerWithParents.parents).forEach((olLayer) => {\n      const layerVisible = olLayer.getVisible();\n      if (layerVisible !== undefined) {\n        visible &= layerVisible;\n      } else {\n        visible = false;\n      }\n    });\n    csPrimitive.show = visible;\n  }\n\n  /**\n   * @inheritDoc\n   */\n  createSingleLayerCounterparts(olLayerWithParents) {\n    const olLayer = olLayerWithParents.layer;\n    if (!(olLayer instanceof olLayerVector)) {\n      return null;\n    }\n    console.assert(olLayer instanceof olLayerLayer);\n\n    let source = olLayer.getSource();\n    if (source instanceof olSourceCluster) {\n      source = source.getSource();\n    }\n\n    if (!source) {\n      return null;\n    }\n\n    console.assert(source instanceof olSourceVector);\n    console.assert(this.view);\n\n    const view = this.view;\n    const featurePrimitiveMap = {};\n    const counterpart = this.converter.olVectorLayerToCesium(olLayer, view,\n        featurePrimitiveMap);\n    const csPrimitives = counterpart.getRootPrimitive();\n    const olListenKeys = counterpart.olListenKeys;\n\n    [olLayerWithParents.layer].concat(olLayerWithParents.parents).forEach((olLayerItem) => {\n      olListenKeys.push(olcsListen(olLayerItem, 'change:visible', () => {\n        this.updateLayerVisibility(olLayerWithParents, csPrimitives);\n      }));\n    });\n    this.updateLayerVisibility(olLayerWithParents, csPrimitives);\n\n    const onAddFeature = (function(feature) {\n      console.assert(\n          (olLayer instanceof olLayerVector) ||\n          (olLayer instanceof olLayerImage)\n      );\n      const context = counterpart.context;\n      const prim = this.converter.convert(olLayer, view, feature, context);\n      if (prim) {\n        featurePrimitiveMap[getUid(feature)] = prim;\n        csPrimitives.add(prim);\n      }\n    }).bind(this);\n\n    const onRemoveFeature = (function(feature) {\n      const id = getUid(feature);\n      const context = counterpart.context;\n      const bbs = context.featureToCesiumMap[id];\n      if (bbs) {\n        delete context.featureToCesiumMap[id];\n        bbs.forEach((bb) => {\n          if (bb instanceof Cesium.Billboard) {\n            context.billboards.remove(bb);\n          }\n        });\n      }\n      const csPrimitive = featurePrimitiveMap[id];\n      delete featurePrimitiveMap[id];\n      if (csPrimitive) {\n        csPrimitives.remove(csPrimitive);\n      }\n    }).bind(this);\n\n    olListenKeys.push(olcsListen(source, 'addfeature', (e) => {\n      console.assert(e.feature);\n      onAddFeature(e.feature);\n    }, this));\n\n    olListenKeys.push(olcsListen(source, 'removefeature', (e) => {\n      console.assert(e.feature);\n      onRemoveFeature(e.feature);\n    }, this));\n\n    olListenKeys.push(olcsListen(source, 'changefeature', (e) => {\n      const feature = e.feature;\n      console.assert(feature);\n      onRemoveFeature(feature);\n      onAddFeature(feature);\n    }, this));\n\n    return counterpart ? [counterpart] : null;\n  }\n}\n\nexport default VectorSynchronizer;\n","/**\n * @module olcs.SynchronizedOverlay\n */\nimport olOverlay from 'ol/Overlay.js';\nimport {transform} from 'ol/proj.js';\nimport {removeNode, removeChildren} from './util.js';\nimport {unByKey as olObservableUnByKey} from 'ol/Observable.js';\n\nclass SynchronizedOverlay extends olOverlay {\n  /**\n   * @param {olcsx.SynchronizedOverlayOptions} options SynchronizedOverlay Options.\n   * @api\n   */\n  constructor(options) {\n    const parent = options.parent;\n    super(parent.getOptions());\n\n    /**\n     * @private\n     * @type {?Function}\n     */\n    this.scenePostRenderListenerRemover_ = null;\n\n    /**\n     * @private\n     * @type {!Cesium.Scene}\n     */\n    this.scene_ = options.scene;\n\n    /**\n     * @private\n     * @type {!olcs.OverlaySynchronizer}\n     */\n    this.synchronizer_ = options.synchronizer;\n\n    /**\n     * @private\n     * @type {!ol.Overlay}\n     */\n    this.parent_ = parent;\n\n    /**\n     * @private\n     * @type {ol.Coordinate|undefined}\n     */\n    this.positionWGS84_ = undefined;\n\n    /**\n     * @private\n     * @type {MutationObserver}\n     */\n    this.observer_ = new MutationObserver(this.handleElementChanged.bind(this));\n\n    /**\n     * @private\n     * @type {Array.<MutationObserver>}\n     */\n    this.attributeObserver_ = [];\n\n    /**\n     * @private\n     * @type {Array<ol.EventsKey>}\n     */\n    this.listenerKeys_ = [];\n    // synchronize our Overlay with the parent Overlay\n    const setPropertyFromEvent = event => this.setPropertyFromEvent_(event);\n    this.listenerKeys_.push(this.parent_.on('change:position', setPropertyFromEvent));\n    this.listenerKeys_.push(this.parent_.on('change:element', setPropertyFromEvent));\n    this.listenerKeys_.push(this.parent_.on('change:offset', setPropertyFromEvent));\n    this.listenerKeys_.push(this.parent_.on('change:position', setPropertyFromEvent));\n    this.listenerKeys_.push(this.parent_.on('change:positioning', setPropertyFromEvent));\n\n    this.setProperties(this.parent_.getProperties());\n\n    this.handleMapChanged();\n    this.handleElementChanged();\n  }\n\n  /**\n   * @param {Node} target\n   * @private\n   */\n  observeTarget_(target) {\n    if (!this.observer_) {\n      // not ready, skip the event (this occurs on construction)\n      return;\n    }\n    this.observer_.disconnect();\n    this.observer_.observe(target, {\n      attributes: false,\n      childList: true,\n      characterData: true,\n      subtree: true\n    });\n    this.attributeObserver_.forEach((observer) => {\n      observer.disconnect();\n    });\n    this.attributeObserver_.length = 0;\n    for (let i = 0; i < target.childNodes.length; i++) {\n      const node = target.childNodes[i];\n      if (node.nodeType === 1) {\n        const observer = new MutationObserver(this.handleElementChanged.bind(this));\n        observer.observe(node, {\n          attributes: true,\n          subtree: true\n        });\n        this.attributeObserver_.push(observer);\n      }\n    }\n  }\n\n  /**\n   *\n   * @param {ol.Object.Event} event\n   * @private\n   */\n  setPropertyFromEvent_(event) {\n    if (event.target && event.key) {\n      this.set(event.key, event.target.get(event.key));\n    }\n  }\n\n  /**\n   * Get the scene associated with this overlay.\n   * @see ol.Overlay.prototype.getMap\n   * @return {!Cesium.Scene} The scene that the overlay is part of.\n   * @api\n   */\n  getScene() {\n    return this.scene_;\n  }\n\n  /**\n   * @override\n   */\n  handleMapChanged() {\n    if (this.scenePostRenderListenerRemover_) {\n      this.scenePostRenderListenerRemover_();\n      removeNode(this.element);\n    }\n    this.scenePostRenderListenerRemover_ = null;\n    const scene = this.getScene();\n    if (scene) {\n      this.scenePostRenderListenerRemover_ = scene.postRender.addEventListener(this.updatePixelPosition.bind(this));\n      this.updatePixelPosition();\n      const container = this.stopEvent ?\n        this.synchronizer_.getOverlayContainerStopEvent() : this.synchronizer_.getOverlayContainer();\n      if (this.insertFirst) {\n        container.insertBefore(this.element, container.childNodes[0] || null);\n      } else {\n        container.appendChild(this.element);\n      }\n    }\n  }\n\n  /**\n   * @override\n   */\n  handlePositionChanged() {\n    // transform position to WGS84\n    const position = this.getPosition();\n    if (position) {\n      const sourceProjection = this.parent_.getMap().getView().getProjection();\n      this.positionWGS84_ = transform(position, sourceProjection, 'EPSG:4326');\n    } else {\n      this.positionWGS84_ = undefined;\n    }\n    this.updatePixelPosition();\n  }\n\n  /**\n   * @override\n   */\n  handleElementChanged() {\n    function cloneNode(node, parent) {\n      const clone = node.cloneNode();\n      if (parent) {\n        parent.appendChild(clone);\n      }\n      if (node.nodeType != Node.TEXT_NODE) {\n        clone.addEventListener('click', (event) => {\n          node.dispatchEvent(new MouseEvent('click', event));\n          event.stopPropagation();\n        });\n      }\n      const nodes = node.childNodes;\n      for (let i = 0; i < nodes.length; i++) {\n        if (!nodes[i]) {\n          continue;\n        }\n        cloneNode(nodes[i], clone);\n      }\n      return clone;\n    }\n    removeChildren(this.element);\n    const element = this.getElement();\n    if (element) {\n      if (element.parentNode && element.parentNode.childNodes) {\n        for (const node of element.parentNode.childNodes) {\n          const clonedNode = cloneNode(node, null);\n          this.element.appendChild(clonedNode);\n        }\n      }\n    }\n    if (element.parentNode) {\n      // set new Observer\n      this.observeTarget_(element.parentNode);\n    }\n  }\n\n  /**\n   * @override\n   */\n  updatePixelPosition() {\n    const position = this.positionWGS84_;\n    if (!this.scene_ || !position) {\n      this.setVisible(false);\n      return;\n    }\n    let cartesian;\n    if (position.length === 2) {\n      cartesian = Cesium.Cartesian3.fromDegreesArray(position)[0];\n    } else {\n      cartesian = Cesium.Cartesian3.fromDegreesArrayHeights(position)[0];\n    }\n    const camera = this.scene_.camera;\n    const ellipsoidBoundingSphere = new Cesium.BoundingSphere(new Cesium.Cartesian3(), 6356752);\n    const occluder = new Cesium.Occluder(ellipsoidBoundingSphere, camera.position);\n    // check if overlay position is behind the horizon\n    if (!occluder.isPointVisible(cartesian)) {\n      this.setVisible(false);\n      return;\n    }\n    const cullingVolume = camera.frustum.computeCullingVolume(camera.position, camera.direction, camera.up);\n    // check if overlay position is visible from the camera\n    if (cullingVolume.computeVisibility(new Cesium.BoundingSphere(cartesian)) !== 1) {\n      this.setVisible(false);\n      return;\n    }\n    this.setVisible(true);\n\n    const pixelCartesian = this.scene_.cartesianToCanvasCoordinates(cartesian);\n    const pixel = [pixelCartesian.x, pixelCartesian.y];\n    const mapSize = [this.scene_.canvas.width, this.scene_.canvas.height];\n    this.updateRenderedPosition(pixel, mapSize);\n  }\n\n  /**\n   * Destroys the overlay, removing all its listeners and elements\n   * @api\n   */\n  destroy() {\n    if (this.scenePostRenderListenerRemover_) {\n      this.scenePostRenderListenerRemover_();\n    }\n    if (this.observer_) {\n      this.observer_.disconnect();\n    }\n    olObservableUnByKey(this.listenerKeys_);\n    this.listenerKeys_.splice(0);\n    if (this.element.removeNode) {\n      this.element.removeNode(true);\n    } else {\n      this.element.remove();\n    }\n    this.element = null;\n  }\n}\n\nexport default SynchronizedOverlay;\n","/**\n * @module olcs.OverlaySynchronizer\n */\nimport olcsSynchronizedOverlay from './SynchronizedOverlay.js';\nimport {getUid} from './util.js';\n\nclass OverlaySynchronizer {\n  /**\n  * @param {!ol.Map} map\n  * @param {!Cesium.Scene} scene\n  * @constructor\n  * @template T\n  * @api\n  */\n  constructor(map, scene) {\n    /**\n    * @type {!ol.Map}\n    * @protected\n    */\n    this.map = map;\n\n    /**\n    * @type {ol.Collection.<ol.Overlay>}\n    * @private\n    */\n    this.overlays_ = this.map.getOverlays();\n\n    /**\n    * @type {!Cesium.Scene}\n    * @protected\n    */\n    this.scene = scene;\n\n    /**\n    * @private\n    * @type {!Element}\n    */\n    this.overlayContainerStopEvent_ = document.createElement('DIV');\n    this.overlayContainerStopEvent_.className = 'ol-overlaycontainer-stopevent';\n    const overlayEvents = ['click', 'dblclick', 'mousedown', 'touchstart', 'MSPointerDown', 'pointerdown', 'mousewheel', 'wheel'];\n    overlayEvents.forEach((event) => {\n      this.overlayContainerStopEvent_.addEventListener(event, evt => evt.stopPropagation());\n    });\n    this.scene.canvas.parentElement.appendChild(this.overlayContainerStopEvent_);\n\n    /**\n    * @private\n    * @type {!Element}\n    */\n    this.overlayContainer_ = document.createElement('DIV');\n    this.overlayContainer_.className = 'ol-overlaycontainer';\n    this.scene.canvas.parentElement.appendChild(this.overlayContainer_);\n\n\n    /**\n    * @type {!Object<?,olcs.SynchronizedOverlay>}\n    * @private\n    */\n    this.overlayMap_ = {};\n  }\n\n  /**\n  * Get the element that serves as a container for overlays that don't allow\n  * event propagation. Elements added to this container won't let mousedown and\n  * touchstart events through to the map, so clicks and gestures on an overlay\n  * don't trigger any {@link ol.MapBrowserEvent}.\n  * @return {!Element} The map's overlay container that stops events.\n  */\n  getOverlayContainerStopEvent() {\n    return this.overlayContainerStopEvent_;\n  }\n\n  /**\n  * Get the element that serves as a container for overlays.\n  * @return {!Element} The map's overlay container.\n  */\n  getOverlayContainer() {\n    return this.overlayContainer_;\n  }\n\n  /**\n  * Destroy all and perform complete synchronization of the overlays.\n  * @api\n  */\n  synchronize() {\n    this.destroyAll();\n    this.addOverlays();\n    this.overlays_.on('add', this.addOverlayFromEvent_.bind(this));\n    this.overlays_.on('remove', this.removeOverlayFromEvent_.bind(this));\n  }\n\n  /**\n  * @param {ol.Collection.Event} event\n  * @private\n  */\n  addOverlayFromEvent_(event) {\n    const overlay = /** @type {ol.Overlay} */ (event.element);\n    this.addOverlay(overlay);\n  }\n\n  /**\n  * @api\n  */\n  addOverlays() {\n    this.overlays_.forEach((overlay) => { this.addOverlay(); });\n  }\n\n  /**\n  * @param {ol.Overlay} overlay\n  * @api\n  */\n  addOverlay(overlay) {\n    if (!overlay) {\n      return;\n    }\n    const cesiumOverlay = new olcsSynchronizedOverlay({\n      scene: this.scene,\n      synchronizer: this,\n      parent: overlay\n    });\n\n    const overlayId = getUid(overlay).toString();\n    this.overlayMap_[overlayId] = cesiumOverlay;\n  }\n\n  /**\n  * @param {ol.Collection.Event} event\n  * @private\n  */\n  removeOverlayFromEvent_(event) {\n    const removedOverlay = /** @type {ol.Overlay} */ (event.element);\n    this.removeOverlay(removedOverlay);\n  }\n\n  /**\n  * Removes an overlay from the scene\n  * @param {ol.Overlay} overlay\n  * @api\n  */\n  removeOverlay(overlay) {\n    const overlayId = getUid(overlay).toString();\n    const csOverlay = this.overlayMap_[overlayId];\n    if (csOverlay) {\n      csOverlay.destroy();\n      delete this.overlayMap_[overlayId];\n    }\n  }\n\n  /**\n  * Destroys all the created Cesium objects.\n  * @protected\n  */\n  destroyAll() {\n    Object.keys(this.overlayMap_).forEach((key) => {\n      const overlay = this.overlayMap_[key];\n      overlay.destroy();\n      delete this.overlayMap_[key];\n    });\n  }\n}\n\n\nexport default OverlaySynchronizer;\n","/**\n * @module olcs.OLCesium\n */\nimport olGeomPoint from 'ol/geom/Point.js';\nimport {getTransform} from 'ol/proj.js';\nimport olcsUtil from './util.js';\nimport olcsCore from './core.js';\nimport olcsAutoRenderLoop from './AutoRenderLoop.js';\nimport olcsCamera from './Camera.js';\nimport olcsRasterSynchronizer from './RasterSynchronizer.js';\nimport olcsVectorSynchronizer from './VectorSynchronizer.js';\nimport olcsOverlaySynchronizer from './OverlaySynchronizer.js';\n\nclass OLCesium {\n  /**\n   * @param {!olcsx.OLCesiumOptions} options Options.\n   * @constructor\n   * @api\n   */\n  constructor(options) {\n\n    /**\n     * @type {olcs.AutoRenderLoop}\n     * @private\n     */\n    this.autoRenderLoop_ = null;\n\n    /**\n     * @type {!ol.Map}\n     * @private\n     */\n    this.map_ = options.map;\n\n    /**\n     * @type {!function(): Cesium.JulianDate}\n     * @private\n     */\n    this.time_ = options.time || function() {\n      return Cesium.JulianDate.now();\n    };\n\n    /**\n     * No change of the view projection.\n     * @private\n     */\n    this.to4326Transform_ = getTransform(this.map_.getView().getProjection(), 'EPSG:4326');\n\n    /**\n     * @type {number}\n     * @private\n     */\n    this.resolutionScale_ = 1.0;\n\n    /**\n     * @type {number}\n     * @private\n     */\n    this.canvasClientWidth_ = 0.0;\n\n    /**\n     * @type {number}\n     * @private\n     */\n    this.canvasClientHeight_ = 0.0;\n\n    /**\n     * @type {boolean}\n     * @private\n     */\n    this.resolutionScaleChanged_ = true; // force resize\n\n    const fillArea = 'position:absolute;top:0;left:0;width:100%;height:100%;';\n\n    /**\n     * @type {!Element}\n     * @private\n     */\n    this.container_ = document.createElement('DIV');\n    const containerAttribute = document.createAttribute('style');\n    containerAttribute.value = `${fillArea}visibility:hidden;`;\n    this.container_.setAttributeNode(containerAttribute);\n\n    let targetElement = options.target || null;\n    if (targetElement) {\n      if (typeof targetElement === 'string') {\n        targetElement = document.getElementById(targetElement);\n      }\n      targetElement.appendChild(this.container_);\n    } else {\n      const oc = this.map_.getViewport().querySelector('.ol-overlaycontainer');\n      if (oc && oc.parentNode) {\n        oc.parentNode.insertBefore(this.container_, oc);\n      }\n    }\n\n    /**\n     * Whether the Cesium container is placed over the ol map.\n     * @type {boolean}\n     * @private\n     */\n    this.isOverMap_ = !targetElement;\n\n\n    if (this.isOverMap_ && options.stopOpenLayersEventsPropagation) {\n      const overlayEvents = ['click', 'dblclick', 'mousedown', 'touchstart', 'MSPointerDown', 'pointerdown', 'mousewheel', 'wheel'];\n      for (let i = 0, ii = overlayEvents.length; i < ii; ++i) {\n        this.container_.addEventListener(overlayEvents[i], evt => evt.stopPropagation());\n      }\n    }\n\n\n    /**\n     * @type {!HTMLCanvasElement}\n     * @private\n     */\n    this.canvas_ = /** @type {!HTMLCanvasElement} */ (document.createElement('CANVAS'));\n    const canvasAttribute = document.createAttribute('style');\n    canvasAttribute.value = fillArea;\n    this.canvas_.setAttributeNode(canvasAttribute);\n\n    if (olcsUtil.supportsImageRenderingPixelated()) {\n      // non standard CSS4\n      this.canvas_.style['imageRendering'] = olcsUtil.imageRenderingValue();\n    }\n\n    this.canvas_.oncontextmenu = function() { return false; };\n    this.canvas_.onselectstart = function() { return false; };\n\n    this.container_.appendChild(this.canvas_);\n\n    /**\n     * @type {boolean}\n     * @private\n     */\n    this.enabled_ = false;\n\n    /**\n     * @type {!Array.<ol.interaction.Interaction>}\n     * @private\n     */\n    this.pausedInteractions_ = [];\n\n    /**\n     * @type {?ol.layer.Group}\n     * @private\n     */\n    this.hiddenRootGroup_ = null;\n\n    const sceneOptions = options.sceneOptions !== undefined ? options.sceneOptions :\n      /** @type {Cesium.SceneOptions} */ ({});\n    sceneOptions.canvas = this.canvas_;\n    sceneOptions.scene3DOnly = true;\n\n    /**\n     * @type {!Cesium.Scene}\n     * @private\n     */\n    this.scene_ = new Cesium.Scene(sceneOptions);\n\n    const sscc = this.scene_.screenSpaceCameraController;\n\n    sscc.tiltEventTypes.push({\n      'eventType': Cesium.CameraEventType.LEFT_DRAG,\n      'modifier': Cesium.KeyboardEventModifier.SHIFT\n    });\n\n    sscc.tiltEventTypes.push({\n      'eventType': Cesium.CameraEventType.LEFT_DRAG,\n      'modifier': Cesium.KeyboardEventModifier.ALT\n    });\n\n    sscc.enableLook = false;\n\n    this.scene_.camera.constrainedAxis = Cesium.Cartesian3.UNIT_Z;\n\n    /**\n     * @type {!olcs.Camera}\n     * @private\n     */\n    this.camera_ = new olcsCamera(this.scene_, this.map_);\n\n    /**\n     * @type {!Cesium.Globe}\n     * @private\n     */\n    this.globe_ = new Cesium.Globe(Cesium.Ellipsoid.WGS84);\n    this.globe_.baseColor = Cesium.Color.WHITE;\n    this.scene_.globe = this.globe_;\n    this.scene_.skyAtmosphere = new Cesium.SkyAtmosphere();\n\n    // The first layer of Cesium is special; using a 1x1 transparent image to workaround it.\n    // See https://github.com/AnalyticalGraphicsInc/cesium/issues/1323 for details.\n    const firstImageryProvider = new Cesium.SingleTileImageryProvider({\n      url: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=',\n      rectangle: Cesium.Rectangle.fromDegrees(0, 0, 1, 1) // the Rectangle dimensions are arbitrary\n    });\n    this.globe_.imageryLayers.addImageryProvider(firstImageryProvider, 0);\n\n    this.dataSourceCollection_ = new Cesium.DataSourceCollection();\n    this.dataSourceDisplay_ = new Cesium.DataSourceDisplay({\n      scene: this.scene_,\n      dataSourceCollection: this.dataSourceCollection_\n    });\n\n    const synchronizers = options.createSynchronizers ?\n      options.createSynchronizers(this.map_, this.scene_, this.dataSourceCollection_) : [\n        new olcsRasterSynchronizer(this.map_, this.scene_),\n        new olcsVectorSynchronizer(this.map_, this.scene_),\n        new olcsOverlaySynchronizer(this.map_, this.scene_)\n      ];\n\n    // Assures correct canvas size after initialisation\n    this.handleResize_();\n\n    for (let i = synchronizers.length - 1; i >= 0; --i) {\n      synchronizers[i].synchronize();\n    }\n\n    /**\n     * Time of the last rendered frame, as returned by `performance.now()`.\n     * @type {number}\n     * @private\n     */\n    this.lastFrameTime_ = 0;\n\n    /**\n     * The identifier returned by `requestAnimationFrame`.\n     * @type {number|undefined}\n     * @private\n     */\n    this.renderId_ = undefined;\n\n    /**\n     * Target frame rate for the render loop.\n     * @type {number}\n     * @private\n     */\n    this.targetFrameRate_ = Number.POSITIVE_INFINITY;\n\n    /**\n     * If the Cesium render loop is being blocked.\n     * @type {boolean}\n     * @private\n     */\n    this.blockCesiumRendering_ = false;\n\n    /**\n     * If the warmup routine is active.\n     * @type {boolean}\n     * @private\n     */\n    this.warmingUp_ = false;\n\n    /**\n     * @type {ol.Feature}\n     * @private\n     */\n    this.trackedFeature_ = null;\n\n    /**\n     * @type {Cesium.Entity}\n     * @private\n     */\n    this.trackedEntity_ = null;\n\n    /**\n     * @type {Cesium.EntityView}\n     * @private\n     */\n    this.entityView_ = null;\n\n    /**\n     * @type {boolean}\n     * @private\n     */\n    this.needTrackedEntityUpdate_ = false;\n\n    /**\n     * @type {!Cesium.BoundingSphere}\n     */\n    this.boundingSphereScratch_ = new Cesium.BoundingSphere();\n\n    const eventHelper = new Cesium.EventHelper();\n    eventHelper.add(this.scene_.postRender, OLCesium.prototype.updateTrackedEntity_, this);\n\n    // Cesium has a mechanism to prevent the camera to go under the terrain.\n    // Unfortunately, it is only active when all the terrain has been loaded, which:\n    // - does not prevent the camera to sink under terrain anymore;\n    // - introduce a jumping effect once all terrain has been loaded and the position of the camera is finally fixed.\n    // The property below enables a workaround found in the Camptocamp Cesium fork.\n    // See also https://github.com/AnalyticalGraphicsInc/cesium/issues/5999.\n    Cesium.Camera.enableSuspendTerrainAdjustment = false;\n  }\n\n  /**\n   * Render the Cesium scene.\n   * @private\n   */\n  render_() {\n    // if a call to `requestAnimationFrame` is pending, cancel it\n    if (this.renderId_ !== undefined) {\n      cancelAnimationFrame(this.renderId_);\n      this.renderId_ = undefined;\n    }\n\n    // only render if Cesium is enabled/warming and rendering hasn't been blocked\n    if ((this.enabled_ || this.warmingUp_) && !this.blockCesiumRendering_) {\n      this.renderId_ = requestAnimationFrame(this.onAnimationFrame_.bind(this));\n    }\n  }\n\n  /**\n   * Callback for `requestAnimationFrame`.\n   * @param {number} frameTime The frame time, from `performance.now()`.\n   * @private\n   */\n  onAnimationFrame_(frameTime) {\n    this.renderId_ = undefined;\n\n    // check if a frame was rendered within the target frame rate\n    const interval = 1000.0 / this.targetFrameRate_;\n    const delta = frameTime - this.lastFrameTime_;\n    if (delta < interval) {\n      // too soon, don't render yet\n      this.render_();\n      return;\n    }\n\n    // time to render a frame, save the time\n    this.lastFrameTime_ = frameTime;\n\n    const julianDate = this.time_();\n    this.scene_.initializeFrame();\n    this.handleResize_();\n    this.dataSourceDisplay_.update(julianDate);\n\n    // Update tracked entity\n    if (this.entityView_) {\n      const trackedEntity = this.trackedEntity_;\n      const trackedState = this.dataSourceDisplay_.getBoundingSphere(trackedEntity, false, this.boundingSphereScratch_);\n      if (trackedState === Cesium.BoundingSphereState.DONE) {\n        this.boundingSphereScratch_.radius = 1; // a radius of 1 is enough for tracking points\n        this.entityView_.update(julianDate, this.boundingSphereScratch_);\n      }\n    }\n\n    this.scene_.render(julianDate);\n    this.camera_.checkCameraChange();\n\n    // request the next render call after this one completes to ensure the browser doesn't get backed up\n    this.render_();\n  }\n\n  /**\n   * @private\n   */\n  updateTrackedEntity_() {\n    if (!this.needTrackedEntityUpdate_) {\n      return;\n    }\n\n    const trackedEntity = this.trackedEntity_;\n    const scene = this.scene_;\n\n    const state = this.dataSourceDisplay_.getBoundingSphere(trackedEntity, false, this.boundingSphereScratch_);\n    if (state === Cesium.BoundingSphereState.PENDING) {\n      return;\n    }\n\n    scene.screenSpaceCameraController.enableTilt = false;\n\n    const bs = state !== Cesium.BoundingSphereState.FAILED ? this.boundingSphereScratch_ : undefined;\n    if (bs) {\n      bs.radius = 1;\n    }\n    this.entityView_ = new Cesium.EntityView(trackedEntity, scene, scene.mapProjection.ellipsoid);\n    this.entityView_.update(this.time_(), bs);\n    this.needTrackedEntityUpdate_ = false;\n  }\n\n  /**\n   * @private\n   */\n  handleResize_() {\n    let width = this.canvas_.clientWidth;\n    let height = this.canvas_.clientHeight;\n\n    if (width === 0 | height === 0) {\n      // The canvas DOM element is not ready yet.\n      return;\n    }\n\n    if (width === this.canvasClientWidth_ &&\n        height === this.canvasClientHeight_ &&\n        !this.resolutionScaleChanged_) {\n      return;\n    }\n\n    let resolutionScale = this.resolutionScale_;\n    if (!olcsUtil.supportsImageRenderingPixelated()) {\n      resolutionScale *= window.devicePixelRatio || 1.0;\n    }\n    this.resolutionScaleChanged_ = false;\n\n    this.canvasClientWidth_ = width;\n    this.canvasClientHeight_ = height;\n\n    width *= resolutionScale;\n    height *= resolutionScale;\n\n    this.canvas_.width = width;\n    this.canvas_.height = height;\n    this.scene_.camera.frustum.aspectRatio = width / height;\n  }\n\n  /**\n   * @return {!olcs.Camera}\n   * @api\n   */\n  getCamera() {\n    return this.camera_;\n  }\n\n  /**\n   * @return {!ol.Map}\n   * @api\n   */\n  getOlMap() {\n    return this.map_;\n  }\n\n  /**\n   * @return {!ol.View}\n   * @api\n   */\n  getOlView() {\n    const view = this.map_.getView();\n    console.assert(view);\n    return view;\n  }\n\n  /**\n   * @return {!Cesium.Scene}\n   * @api\n   */\n  getCesiumScene() {\n    return this.scene_;\n  }\n\n  /**\n   * @return {!Cesium.DataSourceCollection}\n   * @api\n   */\n  getDataSources() {\n    return this.dataSourceCollection_;\n  }\n\n  /**\n   * @return {!Cesium.DataSourceDisplay}\n   * @api\n   */\n  getDataSourceDisplay() {\n    return this.dataSourceDisplay_;\n  }\n\n  /**\n   * @return {boolean}\n   * @api\n   */\n  getEnabled() {\n    return this.enabled_;\n  }\n\n  /**\n   * Enables/disables the Cesium.\n   * This modifies the visibility style of the container element.\n   * @param {boolean} enable\n   * @api\n   */\n  setEnabled(enable) {\n    if (this.enabled_ === enable) {\n      return;\n    }\n    this.enabled_ = enable;\n\n    // some Cesium operations are operating with canvas.clientWidth,\n    // so we can't remove it from DOM or even make display:none;\n    this.container_.style.visibility = this.enabled_ ? 'visible' : 'hidden';\n    let interactions;\n    if (this.enabled_) {\n      this.throwOnUnitializedMap_();\n      if (this.isOverMap_) {\n        interactions = this.map_.getInteractions();\n        interactions.forEach((el, i, arr) => {\n          this.pausedInteractions_.push(el);\n        });\n        interactions.clear();\n\n        const rootGroup = this.map_.getLayerGroup();\n        if (rootGroup.getVisible()) {\n          this.hiddenRootGroup_ = rootGroup;\n          this.hiddenRootGroup_.setVisible(false);\n        }\n\n        this.map_.getOverlayContainer().classList.add('olcs-hideoverlay');\n        this.map_.getOverlayContainerStopEvent().classList.add('olcs-hideoverlay');\n      }\n\n      this.camera_.readFromView();\n      this.render_();\n    } else {\n      if (this.isOverMap_) {\n        interactions = this.map_.getInteractions();\n        this.pausedInteractions_.forEach((interaction) => {\n          interactions.push(interaction);\n        });\n        this.pausedInteractions_.length = 0;\n        this.map_.getOverlayContainer().classList.remove('olcs-hideoverlay');\n        this.map_.getOverlayContainerStopEvent().classList.remove('olcs-hideoverlay');\n        if (this.hiddenRootGroup_) {\n          this.hiddenRootGroup_.setVisible(true);\n          this.hiddenRootGroup_ = null;\n        }\n      }\n\n      this.camera_.updateView();\n    }\n  }\n\n  /**\n   * Preload Cesium so that it is ready when transitioning from 2D to 3D.\n   * @param {number} height Target height of the camera\n   * @param {number} timeout Milliseconds after which the warming will stop\n   * @api\n  */\n  warmUp(height, timeout) {\n    if (this.enabled_) {\n      // already enabled\n      return;\n    }\n    this.throwOnUnitializedMap_();\n    this.camera_.readFromView();\n    const ellipsoid = this.globe_.ellipsoid;\n    const csCamera = this.scene_.camera;\n    const position = ellipsoid.cartesianToCartographic(csCamera.position);\n    if (position.height < height) {\n      position.height = height;\n      csCamera.position = ellipsoid.cartographicToCartesian(position);\n    }\n\n    this.warmingUp_ = true;\n    this.render_();\n\n    setTimeout(() => {\n      this.warmingUp_ = false;\n    }, timeout);\n  }\n\n  /**\n   * Block Cesium rendering to save resources.\n   * @param {boolean} block True to block.\n   * @api\n  */\n  setBlockCesiumRendering(block) {\n    if (this.blockCesiumRendering_ !== block) {\n      this.blockCesiumRendering_ = block;\n\n      // reset the render loop\n      this.render_();\n    }\n  }\n\n  /**\n   * Render the globe only when necessary in order to save resources.\n   * Experimental.\n   * @api\n   */\n  enableAutoRenderLoop() {\n    if (!this.autoRenderLoop_) {\n      this.autoRenderLoop_ = new olcsAutoRenderLoop(this);\n    }\n  }\n\n  /**\n   * Get the autorender loop.\n   * @return {?olcs.AutoRenderLoop}\n   * @api\n  */\n  getAutoRenderLoop() {\n    return this.autoRenderLoop_;\n  }\n\n  /**\n   * The 3D Cesium globe is rendered in a canvas with two different dimensions:\n   * clientWidth and clientHeight which are the dimension on the screen and\n   * width and height which are the dimensions of the drawing buffer.\n   *\n   * By using a resolution scale lower than 1.0, it is possible to render the\n   * globe in a buffer smaller than the canvas client dimensions and improve\n   * performance, at the cost of quality.\n   *\n   * Pixel ratio should also be taken into account; by default, a device with\n   * pixel ratio of 2.0 will have a buffer surface 4 times bigger than the client\n   * surface.\n   *\n   * @param {number} value\n   * @this {olcs.OLCesium}\n   * @api\n   */\n  setResolutionScale(value) {\n    value = Math.max(0, value);\n    if (value !== this.resolutionScale_) {\n      this.resolutionScale_ = Math.max(0, value);\n      this.resolutionScaleChanged_ = true;\n      if (this.autoRenderLoop_) {\n        this.autoRenderLoop_.restartRenderLoop();\n      }\n    }\n  }\n\n  /**\n   * Set the target frame rate for the renderer. Set to `Number.POSITIVE_INFINITY`\n   * to render as quickly as possible.\n   * @param {number} value The frame rate, in frames per second.\n   * @api\n   */\n  setTargetFrameRate(value) {\n    if (this.targetFrameRate_ !== value) {\n      this.targetFrameRate_ = value;\n\n      // reset the render loop\n      this.render_();\n    }\n  }\n\n  /**\n   * Check if OpenLayers map is not properly initialized.\n   * @private\n   */\n  throwOnUnitializedMap_() {\n    const map = this.map_;\n    const view = map.getView();\n    const center = view.getCenter();\n    if (!view.isDef() || isNaN(center[0]) || isNaN(center[1])) {\n      throw new Error(`The OpenLayers map is not properly initialized: ${center} / ${view.getResolution()}`);\n    }\n  }\n}\n\n\nObject.defineProperties(OLCesium.prototype, {\n  'trackedFeature': {\n    'get': /** @this {olcs.OLCesium} */ function() {\n      return this.trackedFeature_;\n    },\n    'set': /** @this {olcs.OLCesium} */ function(feature) {\n      if (this.trackedFeature_ !== feature) {\n\n        const scene = this.scene_;\n\n        //Stop tracking\n        if (!feature || !feature.getGeometry()) {\n          this.needTrackedEntityUpdate_ = false;\n          scene.screenSpaceCameraController.enableTilt = true;\n\n          if (this.trackedEntity_) {\n            this.dataSourceDisplay_.defaultDataSource.entities.remove(this.trackedEntity_);\n          }\n          this.trackedEntity_ = null;\n          this.trackedFeature_ = null;\n          this.entityView_ = null;\n          scene.camera.lookAtTransform(Cesium.Matrix4.IDENTITY);\n          return;\n        }\n\n        this.trackedFeature_ = feature;\n\n        //We can't start tracking immediately, so we set a flag and start tracking\n        //when the bounding sphere is ready (most likely next frame).\n        this.needTrackedEntityUpdate_ = true;\n\n        const to4326Transform = this.to4326Transform_;\n        const toCesiumPosition = function() {\n          const geometry = feature.getGeometry();\n          console.assert(geometry instanceof olGeomPoint);\n          const coo = geometry.getCoordinates();\n          const coo4326 = to4326Transform(coo, undefined, coo.length);\n          return olcsCore.ol4326CoordinateToCesiumCartesian(coo4326);\n        };\n\n        // Create an invisible point entity for tracking.\n        // It is independant from the primitive/geometry created by the vector synchronizer.\n        const options = {\n          'position': new Cesium.CallbackProperty((time, result) => toCesiumPosition(), false),\n          'point': {\n            'pixelSize': 1,\n            'color': Cesium.Color.TRANSPARENT\n          }\n        };\n\n        this.trackedEntity_ = this.dataSourceDisplay_.defaultDataSource.entities.add(options);\n      }\n    }\n  }\n});\n\n\nexport default OLCesium;\n","/**\n * @module olcs.contrib.LazyLoader\n */\nconst exports = class {\n  /**\n   * @param {string} url\n   * @struct\n   * @api\n   */\n  constructor(url) {\n    /**\n     * @type {Promise<undefined>}\n     * @protected\n     */\n    this.promise;\n\n    /**\n     * @private\n     * @type {string}\n     */\n    this.url_ = url;\n  }\n\n  /**\n   * @return {Promise<undefined>}\n   * @api\n   */\n  load() {\n    if (!this.promise) {\n      // not yet loading\n      this.promise = new Promise((resolve, reject) => {\n        const script = document.createElement('script');\n        script.onload = () => resolve();\n        script.onerror = () => reject();\n        document.head.appendChild(script);\n        script.src = this.url_;\n      });\n    }\n    return this.promise;\n  }\n};\n\n\nexport default exports;\n","/**\n * @module olcs.contrib.Manager\n */\nimport olcsContribLazyLoader from '../contrib/LazyLoader.js';\nimport OLCesium from '../OLCesium.js';\nimport olcsCore from '../core.js';\nimport {toRadians} from '../math.js';\nimport olObservable from 'ol/Observable.js';\n\nconst Manager = class extends olObservable {\n  /**\n   * @param {string} cesiumUrl\n   * @param {olcsx.contrib.ManagerOptions} options\n   * @api\n   */\n  constructor(cesiumUrl, {map, cameraExtentInRadians} = {}) {\n\n    super();\n\n    /**\n     * @type {string}\n     * @private\n     */\n    this.cesiumUrl_ = cesiumUrl;\n\n    /**\n     * @type {ol.Map}\n     * @protected\n     */\n    this.map = map;\n\n    /**\n     * @type {ol.Extent}\n     * @protected\n     */\n    this.cameraExtentInRadians = cameraExtentInRadians || null;\n\n    /**\n     * @private\n     * @type {Cesium.BoundingSphere}\n     */\n    this.boundingSphere_;\n\n    /**\n     * @type {boolean}\n     * @private\n     */\n    this.blockLimiter_ = false;\n\n    /**\n     * @type {Promise.<olcs.OLCesium>}\n     * @private\n     */\n    this.promise_;\n\n    /**\n     * @type {olcs.OLCesium}\n     * @protected\n     */\n    this.ol3d;\n\n\n    /**\n     * @const {number} Tilt angle in radians\n     * @private\n     */\n    this.cesiumInitialTilt_ = toRadians(50);\n\n    /**\n     * @protected\n     * @type {number}\n     */\n    this.fogDensity = 0.0001;\n\n    /**\n     * @protected\n     * @type {number}\n     */\n    this.fogSSEFactor = 25;\n\n    /**\n     * Limit the minimum distance to the terrain to 2m.\n     * @protected\n     * @type {number}\n     */\n    this.minimumZoomDistance = 2;\n\n    /**\n     * Limit the maximum distance to the earth to 10'000km.\n     * @protected\n     * @type {number}\n     */\n    this.maximumZoomDistance = 10000000;\n\n    // when closer to 3000m, restrict the available positions harder\n    /**\n     * @protected\n     * @param {number} height\n     */\n    this.limitCameraToBoundingSphereRatio = height => (height > 3000 ? 9 : 3);\n  }\n\n\n  /**\n   * @return {Promise.<olcs.OLCesium>}\n   */\n  load() {\n    if (!this.promise_) {\n      const cesiumLazyLoader = new olcsContribLazyLoader(this.cesiumUrl_);\n      this.promise_ = cesiumLazyLoader.load().then(() => this.onCesiumLoaded());\n    }\n    return this.promise_;\n  }\n\n\n  /**\n   * @protected\n   * @return {olcs.OLCesium}\n   */\n  onCesiumLoaded() {\n    if (this.cameraExtentInRadians) {\n      const rect = new Cesium.Rectangle(...this.cameraExtentInRadians);\n      // Set the fly home rectangle\n      Cesium.Camera.DEFAULT_VIEW_RECTANGLE = rect;\n      this.boundingSphere_ = Cesium.BoundingSphere.fromRectangle3D(rect, Cesium.Ellipsoid.WGS84, 300); // lux mean height is 300m\n    }\n\n    this.ol3d = this.instantiateOLCesium();\n    const scene = this.ol3d.getCesiumScene();\n    this.configureForUsability(scene);\n    this.configureForPerformance(scene);\n    this.dispatchEvent('load');\n    return this.ol3d;\n  }\n\n\n  /**\n   * Application code should override this method.\n   * @return {olcs.OLCesium}\n   */\n  instantiateOLCesium() {\n    console.assert(this.map);\n    const ol3d = new OLCesium({map: this.map});\n    const scene = ol3d.getCesiumScene();\n    const terrainProvider = Cesium.createWorldTerrain();\n    scene.terrainProvider = terrainProvider;\n    return ol3d;\n  }\n\n\n  /**\n   * @param {!Cesium.Scene} scene The scene, passed as parameter for convenience.\n   * @protected\n   */\n  configureForPerformance(scene) {\n    const fog = scene.fog;\n    fog.enabled = true;\n    fog.density = this.fogDensity;\n    fog.screenSpaceErrorFactor = this.fogSSEFactor;\n  }\n\n\n  /**\n   * @param {!Cesium.Scene} scene The scene, passed as parameter for convenience.\n   * @protected\n   */\n  configureForUsability(scene) {\n    const sscController = scene.screenSpaceCameraController;\n    sscController.minimumZoomDistance = this.minimumZoomDistance;\n    sscController.maximumZoomDistance = this.maximumZoomDistance;\n\n    // Do not see through the terrain. Seeing through the terrain does not make\n    // sense anyway, except for debugging\n    scene.globe.depthTestAgainstTerrain = true;\n\n    // Use white instead of the black default colour for the globe when tiles are missing\n    scene.globe.baseColor = Cesium.Color.WHITE;\n    scene.backgroundColor = Cesium.Color.WHITE;\n\n    if (this.boundingSphere_) {\n      scene.postRender.addEventListener(this.limitCameraToBoundingSphere.bind(this), scene);\n    }\n    // Stop rendering Cesium when there is nothing to do. This drastically reduces CPU/GPU consumption.\n    this.ol3d.enableAutoRenderLoop();\n  }\n\n\n  /**\n   * Constrain the camera so that it stays close to the bounding sphere of the map extent.\n   * Near the ground the allowed distance is shorter.\n   * @protected\n   */\n  limitCameraToBoundingSphere() {\n    if (this.boundingSphere_ && !this.blockLimiter_) {\n      const scene = this.ol3d.getCesiumScene();\n      const camera = scene.camera;\n      const position = camera.position;\n      const carto = Cesium.Cartographic.fromCartesian(position);\n      const ratio = this.limitCameraToBoundingSphereRatio(carto.height);\n      if (Cesium.Cartesian3.distance(this.boundingSphere_.center, position) > this.boundingSphere_.radius * ratio) {\n        const currentlyFlying = camera.flying;\n        if (currentlyFlying === true) {\n          // There is a flying property and its value is true\n          return;\n        } else {\n          this.blockLimiter_ = true;\n          const unblockLimiter = () => this.blockLimiter_ = false;\n          camera.flyToBoundingSphere(this.boundingSphere_, {\n            complete: unblockLimiter,\n            cancel: unblockLimiter\n          });\n        }\n      }\n    }\n  }\n\n\n  /**\n   * Enable or disable ol3d with a default animation.\n   * @export\n   * @return {Promise<undefined>}\n   */\n  toggle3d() {\n    return this.load().then((/** @const {!olcs.OLCesium} */ ol3d) => {\n      const is3DCurrentlyEnabled = ol3d.getEnabled();\n      const scene = ol3d.getCesiumScene();\n      if (is3DCurrentlyEnabled) {\n        // Disable 3D\n        console.assert(this.map);\n        return olcsCore.resetToNorthZenith(this.map, scene).then(() => {\n          ol3d.setEnabled(false);\n          this.dispatchEvent('toggle');\n        });\n      } else {\n        // Enable 3D\n        ol3d.setEnabled(true);\n        this.dispatchEvent('toggle');\n        return olcsCore.rotateAroundBottomCenter(scene, this.cesiumInitialTilt_);\n      }\n    });\n  }\n\n\n  /**\n   * Enable ol3d with a view built from parameters.\n   *\n   * @export\n   * @param {number} lon\n   * @param {number} lat\n   * @param {number} elevation\n   * @param {number} headingDeg Heading value in degrees.\n   * @param {number} pitchDeg Pitch value in degrees.\n   * @returns {Promise<undefined>}\n   */\n  set3dWithView(lon, lat, elevation, headingDeg, pitchDeg) {\n    return this.load().then((/** @const {!olcs.OLCesium} */ ol3d) => {\n      const is3DCurrentlyEnabled = ol3d.getEnabled();\n      const scene = ol3d.getCesiumScene();\n      const camera = scene.camera;\n      const destination = Cesium.Cartesian3.fromDegrees(lon, lat, elevation);\n      const heading = Cesium.Math.toRadians(headingDeg);\n      const pitch = Cesium.Math.toRadians(pitchDeg);\n      const roll = 0;\n      const orientation = {heading, pitch, roll};\n\n      if (!is3DCurrentlyEnabled) {\n        ol3d.setEnabled(true);\n        this.dispatchEvent('toggle');\n      }\n\n      camera.setView({\n        destination,\n        orientation\n      });\n    });\n  }\n\n\n  /**\n   * @export\n   * @return {boolean}\n   */\n  is3dEnabled() {\n    return !!this.ol3d && this.ol3d.getEnabled();\n  }\n\n\n  /**\n   * @return {number}\n   */\n  getHeading() {\n    return this.map ? this.map.getView().getRotation() || 0 : 0;\n  }\n\n\n  /**\n   * @return {number|undefined}\n   */\n  getTiltOnGlobe() {\n    const scene = this.ol3d.getCesiumScene();\n    const tiltOnGlobe = olcsCore.computeSignedTiltAngleOnGlobe(scene);\n    return -tiltOnGlobe;\n  }\n\n\n  /**\n   * @param {number} angle\n   */\n  setHeading(angle) {\n    const scene = this.ol3d.getCesiumScene();\n    const bottom = olcsCore.pickBottomPoint(scene);\n    if (bottom) {\n      olcsCore.setHeadingUsingBottomCenter(scene, angle, bottom);\n    }\n  }\n\n  /**\n   * @export\n   * @return {olcs.OLCesium}\n   */\n  getOl3d() {\n    return this.ol3d;\n  }\n\n  /**\n   * @export\n   * @return {!ol.View}\n   */\n  getOlView() {\n    const view = this.map.getView();\n    console.assert(view);\n    return view;\n  }\n\n  /**\n   * @export\n   * @return {Cesium.Matrix4}\n   */\n  getCesiumViewMatrix() {\n    return this.ol3d.getCesiumScene().camera.viewMatrix;\n  }\n\n  /**\n   * @export\n   * @return {!Cesium.Scene}\n   */\n  getCesiumScene() {\n    return this.ol3d.getCesiumScene();\n  }\n\n  /**\n   * @export\n   * @param {!Cesium.Rectangle} rectangle\n   * @param {number=} offset in meters\n   * @return {Promise<undefined>}\n   */\n  flyToRectangle(rectangle, offset = 0) {\n    const camera = this.getCesiumScene().camera;\n    const destination = camera.getRectangleCameraCoordinates(rectangle);\n\n    const mag = Cesium.Cartesian3.magnitude(destination) + offset;\n    Cesium.Cartesian3.normalize(destination, destination);\n    Cesium.Cartesian3.multiplyByScalar(destination, mag, destination);\n\n    return new Promise((resolve, reject) => {\n      if (!this.cameraExtentInRadians) {\n        reject();\n        return;\n      }\n\n      camera.flyTo({\n        destination,\n        complete: () => resolve(),\n        cancel: () => reject(),\n        endTransform: Cesium.Matrix4.IDENTITY\n      });\n    });\n  }\n\n  /**\n   * @protected\n   * @return {Cesium.Rectangle|undefined}\n   */\n  getCameraExtentRectangle() {\n    if (this.cameraExtentInRadians) {\n      return new Cesium.Rectangle(...this.cameraExtentInRadians);\n    }\n  }\n};\n\n\nexport default Manager;\n","import OLCesium from './olcs/OLCesium.js';\n\nimport AbstractSynchronizer from './olcs/AbstractSynchronizer.js';\nimport RasterSynchronizer from './olcs/RasterSynchronizer.js';\nimport VectorSynchronizer from './olcs/VectorSynchronizer.js';\n\nimport * as core from './olcs/core.js';\nimport OLImageryProvider from './olcs/core/OLImageryProvider.js';\nimport VectorLayerCounterpart from './olcs/core/VectorLayerCounterpart.js';\n\nimport LazyLoader from './olcs/contrib/LazyLoader.js';\nimport Manager from './olcs/contrib/Manager.js';\n\n\nexport default OLCesium;\n\n// Using var for phantomJS\n// eslint-disable-next-line no-var\nvar olcs = window['olcs'] = {};\nolcs.OLCesium = OLCesium;\n\nolcs.AbstractSynchronizer = AbstractSynchronizer;\nolcs.RasterSynchronizer = RasterSynchronizer;\nolcs.VectorSynchronizer = VectorSynchronizer;\n\nolcs.core = core.default;\nolcs.core.OLImageryProvider = OLImageryProvider;\nolcs.core.VectorLayerCounterpart = VectorLayerCounterpart;\n\nolcs.contrib = {};\nolcs.contrib.LazyLoader = LazyLoader;\nolcs.contrib.Manager = Manager;\n"],"sourceRoot":""}